import{_ as q}from"./ImportUploadBox-0LEvgHz0.js";import{_ as j}from"./CustomDate-CLArRqjL.js";import{_ as G,a as X,b as Y}from"./CustomMultipleBundle-DHoJd0Qs.js";import{_ as w,F as C,o as f,a as d,w as o,x as u,y as i,c as I,A as y,ac as K,C as h,z as U,a8 as Q,B,G as H,H as z,ab as W,Y as Z,af as ee,a9 as te}from"./index-BtIo2-Z_.js";import{d as se}from"./index-T2HRTWtS.js";import{b as A}from"./route-block-B_A1xBdJ.js";import{V as D,a as O}from"./VRow-9vAZildp.js";import{V as P,a as J,b as ae}from"./VCard-DNHZbZ5d.js";import{V as le}from"./VCheckbox-Berrf7y1.js";import{V as re}from"./VProgressCircular-DNPB7izS.js";import{V as ie}from"./VDataTable-BrBBORsC.js";import{V as oe}from"./VChip-CKNl8kC9.js";import{V as de}from"./index-SDX8Otz2.js";import{V as ne,a as ue}from"./VToolbar-o4oksDe3.js";import{d as me}from"./VList-Cnqqz-5U.js";import{V as pe}from"./VTextField-Bn35T3UG.js";import{V as L}from"./VSpacer-bp7-SSB-.js";import{V as T}from"./VBtn--bGuKZaN.js";import{V as ce}from"./VDialog-CNptTdRK.js";import"./xlsx-CILBIiVl.js";import"./VMenu-Cs322VI3.js";import"./VOverlay-BnbjS8dz.js";import"./forwardRefs--KQCZfKO.js";import"./dialog-transition-Dq7CKyny.js";import"./index-C5-hvfiu.js";import"./VAvatar-l5UJO0sV.js";import"./VImg-FY_z5S7Z.js";import"./filter-ahsWVyiP.js";import"./VInput-CRZE-Mt3.js";import"./VCheckboxBtn-DQUGWCnj.js";/* empty css              */import"./VPagination-zp71F-1D.js";import"./group-DgRBM2CV.js";var fe={FRONT_HOST:"https://raisplus-test.unhcr.in.ua"};const he={Duplicated:"red-darken-2","This tax ID is invalid":"yellow-darken-2","Planned support":"pink-accent-4",Unique:"green-darken-2","Duplicated family member":"orange-darken-2","Planned support for a family member":"pink-darken-4"},be=(e,l=1e4)=>Array.from({length:Math.ceil(e.length/l)},(v,g)=>e.slice(g*l,g*l+l)),E={inject:["$error","$loading"],name:"Deduplication",mounted(){this.appStore.loading=!1},computed:{translatedHeaders(){return this.$i18n.locale==="en"?this.headers:JSON.parse(JSON.stringify(this.headers)).map(l=>(l.title=this.$t(l.title),l))},dialog(){return this.currentItem.length>0}},data(){return{search:void 0,loading:!1,dateFilters:{date:{$lte:void 0,$gte:void 0}},filters:{items:{$nested:{key:[]}}},oneRecord:!0,rows:[],results:[],currentItem:[],headers:[{title:"Tax ID",align:"start",value:"taxId",sortable:!0},{title:"Passport",align:"start",value:"passport",sortable:!0},{title:"Result",align:"start",value:"result",sortable:!0},{title:"Date",align:"start",value:"date",sortable:!0},{title:"Bundle name",align:"start",value:"bundleName",sortable:!0},{title:"Organization",align:"start",value:"organization.name"},{title:"Oblast",align:"start",value:"address.pCode1"},{title:"Raion",align:"start",value:"address.pCode2"},{title:"Hromada",align:"start",value:"address.pCode3"},{title:"Locality",align:"start",value:"address.pCode4"}]}},methods:{async checkBulk(e){var _,x,N,s;let l=e.filter(Boolean).map(t=>{if(t=String(t).replace(/[^А-Я\d]/gi,""),/^\d{9}$/.test(t))return{passport:t};if(/^[А-ЯЄІЇ]{2} *\d{6}$/.test(t.toUpperCase()))return{passport:t.toUpperCase().replace(/^([А-Я]{2})(\d{6})/g,"$1 $2")};const m=ee(t);return m?m.result==="warning"?{taxId:t,result:"This tax ID is invalid"}:{taxId:t}:{taxId:t,result:"This tax ID is invalid"}});const v=l.filter(t=>!t.result).map(t=>t.taxId||t.passport).filter(Boolean),{assistances:g}=this.$storage,a=JSON.parse(JSON.stringify(this.filters)),p=[a],b={peopleIds:v};if((x=(_=this.dateFilters)==null?void 0:_.date)!=null&&x.$lte&&(b.date={$lte:this.dateFilters.date.$lte}),(s=(N=this.dateFilters)==null?void 0:N.date)!=null&&s.$gte&&(b.date||(b.date={}),b.date.$gte=this.dateFilters.date.$gte),a.bundleName&&(b.bundleName=a.bundleName),a.distributionModality&&(b.distributionModality=a.distributionModality),!a.distributionModality||a.distributionModality.includes("Cash")||a.distributionModality.includes("Voucher")){const t={value:{$gt:0}};t.distributionModality||delete t.distributionModality,p.push(t)}let r=await g.useIndex("peopleIds").slice(0,1e4).filter(b).sort({date:"desc"}).should(p).include(["headOfHousehold.taxId","headOfHousehold.passport","familyMembers.taxId","familyMembers.passport","date","bundleName","organization.name","admin1","admin2","admin3","admin4","address.pCode1","address.pCode2","address.pCode3","address.pCode4"]).find();return r.count||(this.results=l,this.loading=!1),r.items=r.items.map(t=>te.object(t)),l=l.map(t=>{var V,c;if(t.result)return t;let m=[];if(t.passport&&(m=r.items.filter(n=>{var k;return((k=n.headOfHousehold)==null?void 0:k.passport)===t.passport})),t.taxId&&(m=r.items.filter(n=>{var k,$,F,M,R;return(k=n.headOfHousehold)!=null&&k.taxId&&(($=n.headOfHousehold)==null?void 0:$.taxId)===t.taxId||(F=n.familyMembers)!=null&&F.map(S=>S.taxId).includes(t.taxId)||(M=n.familyMembers)!=null&&M.map(S=>S.taxId).includes(t.taxId)?!0:n.taxIds&&((R=n.taxIds)==null?void 0:R.includes(t.taxId))})),!m.length)return{...t,result:"Unique"};if(this.oneRecord){let n={...m[0],...t,items:m};return t.taxId&&((V=m[0].headOfHousehold)==null?void 0:V.taxId)===t.taxId||t.passport&&((c=m[0].headOfHousehold)==null?void 0:c.passport)===t.passport?(n.result=new Date(m[0].date)<new Date?"Duplicated":"Planned support",n):(n.result=new Date(m[0].date)<new Date?"Duplicated family member":"Planned support for a family member",n)}return m=m.map(n=>{var k,$;return n={...n,...t,items:[]},t.taxId&&((k=n.headOfHousehold)==null?void 0:k.taxId)===t.taxId||t.passport&&(($=n.headOfHousehold)==null?void 0:$.passport)===t.passport?(n.result=new Date(n.date)<new Date?"Duplicated":"Planned support",n):(n.result=new Date(n.date)<new Date?"Duplicated family member":"Planned support for a family member",n)}),m}).flat(),l},async checkAll(){let e=JSON.parse(JSON.stringify(this.rows));if(Array.isArray(e)||(e=[e]),e.length===1&&!Array.isArray(e[0])&&(e=[e]),e=e.map(a=>a[0]).filter(Boolean),!e.length)return!1;this.loading=!0;const l=be(e),v=l.length,g=[];for(const a of l){let p=await this.checkBulk(a);v>1&&(p=p.filter(b=>b.result!=="Unique")),g.push(...p)}this.results=g,this.loading=!1},formatDate(e){return e?Z(e).toLocaleDateString("uk"):""},getColor(e){return he[e]},getFileName(){var g,a,p,b;const e=((a=(g=this.appStore)==null?void 0:g.user)==null?void 0:a.name)||"User",l=((b=(p=this.appStore)==null?void 0:p.user)==null?void 0:b.email)||"no@email";return`${new Date().toISOString().substring(0,10)} - Deduplication data for ${e} (${l}).xlsx`},exportData(){let e=JSON.parse(JSON.stringify(this.results));const l=["Tax ID","Passport","Result","Date","Bundle name","Organization","Oblast","Raion","Hromada","Locality","pCode1","pCode2","pCode3","pCode4"],v=["taxId","passport","result","date","bundleName","organization.name","admin1","admin2","admin3","admin4","address.pCode1","address.pCode2","address.pCode3","address.pCode4"],g=`${fe.FRONT_HOST}/export/export.xlsx`,a=this.getFileName();e=e.map(r=>{var _;return r.bundleName=this.$t(r.bundleName),(_=r.address)!=null&&_.pCode4&&(r.address.pCode1=r.address.pCode4.substring(0,4),r.address.pCode2=r.address.pCode4.substring(0,6),r.address.pCode3=r.address.pCode4.substring(0,9),r.admin1=r.address.pCode4?this.$t(r.address.pCode4.substring(0,4),"en"):"",r.admin2=r.address.pCode4?this.$t(r.address.pCode4.substring(0,6),"en"):"",r.admin3=r.address.pCode4?this.$t(r.address.pCode4.substring(0,9),"en"):"",r.admin4=r.address.pCode4?this.$t(r.address.pCode4,"en"):""),r});const p=v.map(r=>e.map(_=>W(r,_)));(async()=>await se(g,{headers:l,columns:p},a))()}}},ge={class:"guide pa-2"},ye={class:"text-h4 font-weight-bold"},Ce={class:"text-h5 mb-2 offset-md1 black--text"},_e={class:"mt-4"},ve={style:{"white-space":"nowrap"}},Ve={sclass:"text-no-wrap"},ke={class:"text-no-wrap"},De={class:"text-no-wrap"},Ie={class:"d-flex w-100"},xe={class:"bg-blue-grey-lighten-5 pa-4 flex-grow-1"},$e={class:"text-h6 mt-4"},Ne={class:"mb-6 mt-2"},Oe={class:"mt-2 mb-2"},Se={key:0,class:"mt-2 mb-2"},Te={key:1,class:"mt-2 mb-2"},Fe={key:2,class:"mt-2 mb-2"},Me={key:3,class:"mt-2 mb-2"},Re={class:"mt-2 mb-2"},Ue={key:4,class:"mt-2 mb-2"},Be={class:"ml-6"},He={key:5,class:"mt-2 mb-2"};function ze(e,l,v,g,a,p){const b=G,r=X,_=Y,x=j,N=q;return f(),C("div",ge,[d(O,{class:"mb-0 mt-0"},{default:o(()=>[d(D,{cols:"12",md:"12",class:"mb-0 mt-0 pb-4 pt-0 pl-md-8 pr-md-8"},{default:o(()=>[u("div",ye,i(e.$t("Deduplication")),1)]),_:1})]),_:1}),d(O,{class:"mb-0 mt-0"},{default:o(()=>[d(D,{cols:"12",md:"12",class:"mb-0 mt-0 pb-0 pt-0 pl-md-8 pr-md-8"},{default:o(()=>[d(P,{class:"pt-sm-4 pb-sm-4 pt-md-16 pb-md-16"},{default:o(()=>[d(J,null,{default:o(()=>[d(O,null,{default:o(()=>[d(D,{cols:"12",md:"3",class:"pl-md-16"},{default:o(()=>{var s,t,m,V;return[u("div",Ce,i(e.$t("Deduplication")),1),u("div",null,i(e.$t("Please specify the necessary filter and provide the list of tax IDs to obtain information regarding the support provided")),1),u("div",_e,[d(le,{modelValue:a.oneRecord,"onUpdate:modelValue":l[0]||(l[0]=c=>a.oneRecord=c),disabled:a.results.length,label:e.$t("Show only one record per person")},null,8,["modelValue","disabled","label"]),d(b,{modelValue:a.filters.bundleName,"onUpdate:modelValue":l[1]||(l[1]=c=>a.filters.bundleName=c)},null,8,["modelValue"]),d(r,{modelValue:a.filters.distributionModality,"onUpdate:modelValue":l[2]||(l[2]=c=>a.filters.distributionModality=c),class:"mt-4"},null,8,["modelValue"]),((t=(s=a.filters)==null?void 0:s.bundleName)==null?void 0:t.length)===1&&((V=(m=a.filters)==null?void 0:m.distributionModality)==null?void 0:V.length)===1&&a.filters.distributionModality[0]==="In-kind"?(f(),I(_,{key:0,modelValue:a.filters.items.$nested.key,"onUpdate:modelValue":l[3]||(l[3]=c=>a.filters.items.$nested.key=c),bundle:a.filters.bundleName[0],class:"mt-4"},null,8,["modelValue","bundle"])):y("",!0),d(x,{modelValue:a.dateFilters.date.$gte,"onUpdate:modelValue":l[4]||(l[4]=c=>a.dateFilters.date.$gte=c),label:e.$t("Start of support"),class:"mt-4"},null,8,["modelValue","label"]),d(x,{modelValue:a.dateFilters.date.$lte,"onUpdate:modelValue":l[5]||(l[5]=c=>a.dateFilters.date.$lte=c),label:e.$t("End of support")},null,8,["modelValue","label"])])]}),_:1}),d(D,{cols:"12",md:"9",class:"pr-md-16"},{default:o(()=>[d(O,null,{default:o(()=>[!a.loading&&!a.results.length?(f(),I(D,{key:0,cols:"12"},{default:o(()=>[d(N,{modelValue:a.rows,"onUpdate:modelValue":[l[6]||(l[6]=s=>a.rows=s),p.checkAll],"bundle-name":"none",checkAll:""},null,8,["modelValue","onUpdate:modelValue"])]),_:1})):y("",!0),a.loading?(f(),I(D,{key:1,cols:"12",class:"text-center"},{default:o(()=>[d(re,{color:"primary",indeterminate:"",size:"x-large"})]),_:1})):y("",!0),!a.loading&&a.results.length?(f(),I(D,{key:2,cols:"12",class:"pt-0"},{default:o(()=>[d(ie,{items:a.results,headers:p.translatedHeaders,search:a.search,"no-data-text":e.$t("No data available"),"items-per-page-text":e.$t("Items per page")},{top:o(()=>[U(d(ne,{flat:"",color:"white"},{default:o(()=>[d(ue,{style:{"min-width":"150px"}},{default:o(()=>[h(i(e.$t("Results")),1)]),_:1}),d(me,{class:"mx-4",inset:"",vertical:""}),d(pe,{modelValue:a.search,"onUpdate:modelValue":l[7]||(l[7]=s=>a.search=s),class:"mr-4 w-100",variant:"outlined",density:"compact",label:e.$t("Search"),"hide-details":"","prepend-icon":"mdi-magnify"},null,8,["modelValue","label"]),d(L),Q(e.$slots,"action-btn",{},()=>[d(T,{onClick:l[8]||(l[8]=s=>a.results=[]),color:"error",variant:"text",class:"mr-2"},{default:o(()=>[h(i(e.$t("Reset")),1)]),_:1}),d(T,{onClick:p.exportData,color:"primary",variant:"tonal"},{default:o(()=>[h(i(e.$t("Export")),1)]),_:1},8,["onClick"])])]),_:3},512),[[B,!e.$vuetify.display.xs]])]),"item.address.pCode1":o(({item:s})=>{var t;return[h(i(((t=s.address)==null?void 0:t.pCode4)&&e.$t(s.address.pCode4.substring(0,4))),1)]}),"item.address.pCode2":o(({item:s})=>{var t;return[h(i(((t=s.address)==null?void 0:t.pCode4)&&e.$t(s.address.pCode4.substring(0,6))),1)]}),"item.address.pCode3":o(({item:s})=>{var t;return[h(i(((t=s.address)==null?void 0:t.pCode4)&&e.$t(s.address.pCode4.substring(0,9))),1)]}),"item.address.pCode4":o(({item:s})=>{var t;return[h(i(((t=s.address)==null?void 0:t.pCode4)&&e.$t(s.address.pCode4)),1)]}),"item.result":o(({item:s})=>[u("span",ve,[d(oe,{onClick:t=>a.oneRecord&&(a.currentItem=s.items),class:K({"cursor-pointer":["Duplicated family member","Duplicated"].includes(s.result)}),label:"",color:p.getColor(s.result),variant:"elevated",size:"small"},{default:o(()=>[h(i(e.$t(s.result))+" ",1),["Duplicated family member","Duplicated"].includes(s.result)?(f(),I(de,{key:0,class:"ml-2"},{default:o(()=>l[10]||(l[10]=[h(" mdi-information ")])),_:1})):y("",!0)]),_:2},1032,["onClick","class","color"])])]),"item.bundleName":o(({item:s})=>[u("span",Ve,i(e.$t(s.bundleName)),1)]),"item.organization":o(({item:s})=>{var t;return[u("span",ke,i((t=s.organization)==null?void 0:t.name),1)]}),"item.date":o(({item:s})=>[u("span",De,i(p.formatDate(s.date)),1)]),_:2},1032,["items","headers","search","no-data-text","items-per-page-text"])]),_:3})):y("",!0)]),_:3})]),_:3})]),_:3})]),_:3})]),_:3})]),_:3})]),_:3}),d(ce,{"model-value":p.dialog},{default:o(()=>[d(P,{title:e.$t("Duplications"),"max-width":"600",class:"margin-auto custom-thumb"},{default:o(()=>[a.currentItem.length?(f(),I(J,{key:0},{default:o(()=>[u("div",Ie,[u("div",xe,[u("div",$e,i(e.$t("Deduplication results")),1),u("div",Ne,[u("div",null,[u("strong",null,i(e.$t("This person has already received the support from humanitarian organizations")),1)])]),(f(!0),C(H,null,z(a.currentItem,s=>{var t,m,V,c;return f(),C("div",{key:s.publicId,class:"mb-7 pl-2",style:{"border-left":"2px solid #039BE5"}},[u("div",Oe,[u("strong",null,i(e.$t("Date"))+":",1),h(" "+i(new Date(s.date).toLocaleDateString("uk")),1)]),s.bundleName?(f(),C("div",Se,[u("strong",null,i(e.$t("Assistance type"))+":",1),h(" "+i(e.$t(s.bundleName)),1)])):y("",!0),(t=s.address)!=null&&t.pCode1?(f(),C("div",Te,[u("strong",null,i(e.$t("Oblast"))+":",1),h(" "+i(e.$t(s.address.pCode1)),1)])):y("",!0),(m=s.address)!=null&&m.pCode2?(f(),C("div",Fe,[u("strong",null,i(e.$t("Raion"))+":",1),h(" "+i(e.$t(s.address.pCode2)),1)])):y("",!0),(V=s.address)!=null&&V.pCode4?(f(),C("div",Me,[u("strong",null,i(e.$t("Locality"))+":",1),h(" "+i(e.$t(s.address.pCode4)),1)])):y("",!0),u("div",Re,[u("strong",null,i(e.$t("Organization"))+":",1),h(" "+i((c=s.organization)==null?void 0:c.name),1)]),s.items&&s.items.length?(f(),C("div",Ue,[u("div",null,[u("strong",null,i(e.$t("Items"))+":",1)]),u("ul",Be,[(f(!0),C(H,null,z(s.items,n=>U((f(),C("li",null,i(e.$t(n.key))+": "+i(n.value),513)),[[B,n.value]])),256))])])):y("",!0),s.value?(f(),C("div",He,[u("strong",null,i(e.$t("Value"))+":",1),h(" "+i(s.value?s.value.toLocaleString("uk-UA",{style:"currency",currency:s.currency||"USD"}):""),1)])):y("",!0)])}),128))])])]),_:1})):y("",!0),d(ae,null,{default:o(()=>[d(L),d(T,{text:e.$t("Close"),color:"primary",onClick:l[9]||(l[9]=s=>a.currentItem=[])},null,8,["text"])]),_:1})]),_:1},8,["title"])]),_:1},8,["model-value"])])}typeof A=="function"&&A(E);const yt=w(E,[["render",ze]]);export{yt as default};
