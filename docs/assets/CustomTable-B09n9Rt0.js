import{_ as A}from"./CustomDate-CfhxorUI.js";import{d as _}from"./debouncer-Whu4ZLob.js";import{a9 as x,a3 as u,a6 as y,a2 as h,a7 as c,W as m,a4 as l,u as r,Y as f,Q as k,S,F as j,aa as w,ad as D,ae as N,ac as C,af as z,ag as K}from"./@vue-CVhpfiSJ.js";import{_ as O}from"./index-Dr3A69Vy.js";import{n as p,h as E,l as P,m as U,f as v,t as L,A as R,z as F,I as B,r as q,i as J,j as M,k as H,C as Q,o as W,p as T,a7 as Y,a8 as G,N as X,O as Z,P as $}from"./vuetify-8yKwgmF2.js";import{d as tt}from"./searchProcessor-BfIe0Ps2.js";const I=t=>{const[e,a]=t.split(/\./g);return a==="0"||e.length===3?e:t},et=t=>t/10**9>1?I((t/10**9).toFixed(1))+"B":t/10**6>1?I((t/10**6).toFixed(1))+"M":t/10**3>1?I((t/10**3).toFixed(1))+"K":t,at={name:"CustomTableHeader",props:{table:{type:String},index:{type:String},column:{type:Object,default:{}},datatable:{type:Object,default:{}}},data(){return{loading:!1,search:void 0,items:[],menu:!1}},computed:{title(){let t=this.column.value;return this.column.translated&&this.$i18n.locale!=="en"&&(t=this.column.translated),t},key(){return this.column.filterId||this.column.value},startDate:{get(){return this.datatable.start},set(t){this.$emit("setStart",t)}},endDate:{get(){return this.datatable.end},set(t){this.$emit("setEnd",t)}},showItems(){if(!this.search)return this.items;const t=new RegExp(this.search.replace(/[|\\{}()[\]^$+*?.]/g,".").replace(/-/g,"\\-"),"gi");return this.items.filter(e=>{var o;let a=e.title.replace("@","＠");return this.$i18n.locale!=="en"&&((o=this.column)!=null&&o.translated)?a.match(t):this.$t(a).match(t)})},filterIsSet(){var t,e,a,o;return(e=(t=this.datatable)==null?void 0:t.filters)!=null&&e[this.key]?(o=(a=this.datatable)==null?void 0:a.filters)==null?void 0:o[this.key].length:!1}},methods:{setSearch:_(function(t){if(!menu)return!1;this.loadItems()}),async loadItems(){var n,b,s;if(!((n=this.column)!=null&&n.filterable)||this.column.type==="date")return!1;this.loading=!0;let t=this.$storage[this.table];if(this.index&&(t=t.useIndex(this.index)),this.datatable.filters){const d={...this.datatable.filters};delete d[this.key],d&&Object.keys(d).length&&(t=t.filter(d))}if(this.search&&(t=t.should({[this.title]:{$regex:this.search}})),this.datatable.end||this.datatable.start){const d=Object.fromEntries([["$lte",this.datatable.end],["$gte",this.datatable.start]].filter(([,V])=>V));t=t.filter({date:d})}t=t.sort([{value:"desc"},{[this.key]:"asc"}]);const e={groupBy:[this.key],aggs:{value:{variable:"id",operation:"count"}}};this.column.filterId&&e.groupBy.push(this.title);let a=await t.aggregate(e);a=a.map(d=>(d.key||(d.key=d[this.key],d.title=d[this.title]),d));const o=a.map(d=>d.key),i=((s=(b=this.datatable)==null?void 0:b.filters)==null?void 0:s[this.key])||[];for(let d of i)o.includes(d)||a.push({key:d,value:0});this.items=a,this.loading=!1},isSorted({value:t}){var a,o,i,n;return(a=this.datatable)!=null&&a.sortBy?(Array.isArray((o=this.datatable)==null?void 0:o.sortBy)?(i=this.datatable)==null?void 0:i.sortBy[0]:(n=this.datatable)==null?void 0:n.sortBy).key===t:!1},isFiltered({value:t}){var e;if(!((e=this.datatable)!=null&&e.filters))return!1;for(let[a,o]of Object.entries(this.datatable.filters))if(a===t&&o.length)return!0},getIcon(t){var e,a;return this.isSorted(t)?(Array.isArray(this.datatable.sortBy)?(e=this.datatable)==null?void 0:e.sortBy[0]:(a=this.datatable)==null?void 0:a.sortBy).order==="desc"?"mdi-sort-descending":"mdi-sort-ascending":this.isFiltered(t)?"mdi-filter":"mdi-chevron-down"},setSort(t){this.$emit("setSort",{key:this.title,order:t}),this.menu=!1},hasFilter(t){var e,a,o,i;return(a=(e=this.datatable)==null?void 0:e.filters)!=null&&a[this.key]?(i=(o=this.datatable)==null?void 0:o.filters)==null?void 0:i[this.key].includes(t):!1},switchFilter(t){const e={...this.datatable.filters};e[this.key]=e[this.key]||[];let a=e[this.key].indexOf(t);return a>=0?(e[this.key].splice(a,1),e[this.key].length||delete e[this.key],this.$emit("setFilter",e)):(e[this.key].push(t),this.$emit("setFilter",e))},resetAllFilters(){const t=JSON.parse(JSON.stringify(this.datatable.filters));return delete t[this.key],this.$emit("setFilter",t)},simplifyCount:et},watch:{menu(t){this.search=void 0,t&&this.loadItems()}}},st={class:"text-no-wrap bg-grey-lighten-3"},lt={class:"font-weight-bold"},it={class:"mb-2"},rt={class:"text-center"},nt={style:{width:"36px"}};function dt(t,e,a,o,i,n){const b=A;return u(),x("td",st,[y("div",{class:D(["w-100 d-flex align-center",{"justify-center":a.column.align==="center","justify-end":a.column.align==="right"}])},[y("span",lt,m(t.$t(a.column.title)),1),a.column.sortable||a.column.filterable?(u(),h(v,{key:0,style:{"min-width":"0px"},class:"ml-2 pa-2",size:"small",variant:"text",elevation:"0",color:n.isFiltered(a.column)?"primary":"black"},{default:l(()=>[r(p,null,{default:l(()=>[f(m(n.getIcon(a.column)),1)]),_:1}),r(E,{modelValue:i.menu,"onUpdate:modelValue":e[7]||(e[7]=s=>i.menu=s),"close-on-content-click":!1,activator:"parent",transition:"slide-y-transition"},{default:l(()=>[r(P,{"max-width":"350",width:"350"},{default:l(()=>[r(U,{class:"pa-0"},{default:l(()=>[a.column.sortable?(u(),h(v,{key:0,onClick:e[0]||(e[0]=s=>n.setSort("asc")),block:"",rounded:"0",variant:"plain",class:"justify-start"},{default:l(()=>[r(p,{class:"mr-2"},{default:l(()=>e[8]||(e[8]=[f("mdi-sort-ascending")])),_:1}),f(" "+m(t.$t("Sort ascending")),1)]),_:1})):c("",!0),a.column.sortable?(u(),h(v,{key:1,onClick:e[1]||(e[1]=s=>n.setSort("desc")),block:"",rounded:"0",variant:"plain",class:"justify-start"},{default:l(()=>[r(p,{class:"mr-2"},{default:l(()=>e[9]||(e[9]=[f("mdi-sort-descending")])),_:1}),f(" "+m(t.$t("Sort descending")),1)]),_:1})):c("",!0),a.column.filterable?(u(),h(L,{key:2},{default:l(()=>[r(R,null,{default:l(()=>[r(F,{cols:"12"},{default:l(()=>[y("div",it,[y("strong",null,m(t.$t("Filter").toUpperCase()),1)]),a.column.type==="date"?(u(),h(b,{key:0,modelValue:n.startDate,"onUpdate:modelValue":e[2]||(e[2]=s=>n.startDate=s),label:t.$t("Start date"),clearable:"",class:"mt-4"},null,8,["modelValue","label"])):c("",!0),a.column.type==="date"?(u(),h(b,{key:1,modelValue:n.endDate,"onUpdate:modelValue":e[3]||(e[3]=s=>n.endDate=s),clearable:"",label:t.$t("End date")},null,8,["modelValue","label"])):c("",!0),a.column.type==="term"?(u(),h(B,{key:2,modelValue:i.search,"onUpdate:modelValue":e[4]||(e[4]=s=>i.search=s),label:t.$t("Search"),variant:"outlined",density:"compact",clearable:"","hide-details":""},null,8,["modelValue","label"])):c("",!0),a.column.type==="string"?(u(),h(B,{key:3,modelValue:i.search,"onUpdate:modelValue":[e[5]||(e[5]=s=>i.search=s),n.setSearch],label:t.$t("Search"),variant:"outlined",density:"compact",clearable:"","hide-details":""},null,8,["modelValue","onUpdate:modelValue","label"])):c("",!0)]),_:1}),a.column.type!=="date"?(u(),h(F,{key:0,cols:"12",class:"pa-0"},{default:l(()=>[k(y("div",rt,[r(q,{indeterminate:"",color:"primary"})],512),[[S,i.loading]]),k(r(J,{class:"custom-thumb",nav:"",density:"compact",lines:!1,"max-height":"200"},{default:l(()=>[(u(!0),x(j,null,w(n.showItems,s=>(u(),h(M,{onClick:d=>n.switchFilter(s.key),key:s.key,density:"compact"},{prepend:l(()=>[y("div",nt,[k(r(p,null,{default:l(()=>e[10]||(e[10]=[f("mdi-checkbox-blank-outline")])),_:2},1536),[[S,!n.hasFilter(s.key)]]),k(r(p,null,{default:l(()=>e[11]||(e[11]=[f("mdi-checkbox-outline")])),_:2},1536),[[S,n.hasFilter(s.key)]])])]),append:l(()=>[r(Q,{size:"x-small"},{default:l(()=>[f(m(n.simplifyCount(s.value)),1)]),_:2},1024)]),default:l(()=>[r(H,{class:"pr-2"},{default:l(()=>{var d;return[f(m(a.column.type==="term"?t.$t((d=s==null?void 0:s.title)==null?void 0:d.replace("@","＠")):s==null?void 0:s.title),1)]}),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1},512),[[S,!i.loading]])]),_:1})):c("",!0)]),_:1})]),_:1})):c("",!0)]),_:1}),a.column.filterable?(u(),h(W,{key:0},{default:l(()=>[k(r(v,{onClick:n.resetAllFilters,size:"x-small"},{default:l(()=>[r(p,{class:"mr-2"},{default:l(()=>e[12]||(e[12]=[f("mdi-checkbox-blank-outline")])),_:1}),f(" "+m(t.$t("Reset all")),1)]),_:1},8,["onClick"]),[[S,n.filterIsSet]]),r(T),r(v,{onClick:e[6]||(e[6]=s=>i.menu=!1),size:"x-small"},{default:l(()=>[f(m(t.$t("Close")),1)]),_:1})]),_:1})):c("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["color"])):c("",!0)],2)])}const ot=O(at,[["render",dt]]),ut={name:"CustomTable",props:{table:{type:String},index:{type:String},filters:{type:Object,default:()=>({})},sortBy:{type:Object},searchKeys:{type:Array,default:[]},title:{type:String,default:"Table"},headers:{type:Array,default:()=>[]},buttonIcon:{type:String},button:{type:String}},created(){let{query:t}=this.$route.query;if(t)return t=JSON.parse(atob(t)),this.datatable=t,!1;this.filters&&Object.keys(this.filters).length&&(this.datatable.filters=this.filters),this.datatable.searchKeys=this.searchKeys,this.sortBy&&(this.datatable.sortBy=[this.sortBy])},data(){return{datatable:{search:"",searchKeys:[],start:void 0,end:void 0,filters:{},page:1,itemsPerPage:20,totalItems:0,sortBy:void 0},search:void 0,loading:!1,items:[]}},computed:{translated(){return this.items.map(t=>this.$_translate(t))}},methods:{setSearch:_(function(t){this.datatable.search=t}),async loadItems(){this.loading=!0;let t=this.$storage[this.table];this.index&&(t=t.useIndex(this.index)),t=tt(t,this.datatable,this.searchKeys);const e=await t.find();e&&(this.items=e.items,this.datatable.totalItems=e.count),this.appStore.loading=!1,this.loading=!1},isSorted({value:t}){return this.sortBy.key===t},isFiltered({value:t}){if(!this.filters)return!1;for(let[e,a]of Object.entries(this.filters))if(e===t&&a.length)return!0},getIcon(t){return this.isSorted(t)?this.sortBy==="desc"?"mdi-sort-descending":"mdi-sort-ascending":this.isFiltered(t)?"mdi-filter":"mdi-chevron-down"},setFilter(t){this.datatable.filters=t,this.loadItems()}},watch:{filters:{handler(t){this.datatable.filters=t,this.loadItems()},deep:!0},"datatable.start"(){this.loadItems()},"datatable.end"(){this.loadItems()}}},ft={slot:"progress"};function ht(t,e,a,o,i,n){const b=ot;return u(),h(P,{class:"custom-table"},{default:l(()=>[y("template",ft,[r(Y,{color:"blue",height:"10",indeterminate:""})]),r(U,{class:"pa-0"},{default:l(()=>[r(G,{"items-per-page":i.datatable.itemsPerPage,"onUpdate:itemsPerPage":e[6]||(e[6]=s=>i.datatable.itemsPerPage=s),"sort-by":i.datatable.sortBy,"onUpdate:sortBy":e[7]||(e[7]=s=>i.datatable.sortBy=s),page:i.datatable.page,"onUpdate:page":e[8]||(e[8]=s=>i.datatable.page=s),search:i.datatable.search,headers:a.headers,"items-length":i.datatable.totalItems,items:n.translated,loading:i.loading,"loading-text":t.$t("Loading... Please wait"),"items-per-page-text":t.$t("Records per page"),"item-value":"_id","onUpdate:options":n.loadItems},N({top:l(()=>[k(r(X,{flat:"",color:"white"},{default:l(()=>[r(Z,{style:{"min-width":"150px"}},{default:l(()=>[f(m(a.title),1)]),_:1}),r($,{class:"mx-4",inset:"",vertical:""}),r(B,{modelValue:i.search,"onUpdate:modelValue":[e[0]||(e[0]=s=>i.search=s),n.setSearch],class:"mr-4 w-100",variant:"outlined",density:"compact",label:t.$t("Search"),"hide-details":"","prepend-icon":"mdi-magnify"},null,8,["modelValue","onUpdate:modelValue","label"]),r(T),C(t.$slots,"action-btn",{},()=>[k(r(v,{onClick:e[1]||(e[1]=s=>t.$emit("btnClick")),color:"primary",variant:"flat"},{default:l(()=>[r(p,{left:""},{default:l(()=>e[9]||(e[9]=[f("mdi-plus")])),_:1}),f(" "+m(a.button),1)]),_:1},512),[[S,a.button]])])]),_:3},512),[[S,!t.$vuetify.display.xs]])]),headers:l(({columns:s,toggleSort:d})=>[y("tr",null,[(u(!0),x(j,null,w(s,V=>(u(),h(b,{key:V.key,onSetSort:e[2]||(e[2]=g=>i.datatable.sortBy=[g]),onSetFilter:e[3]||(e[3]=g=>n.setFilter(g)),onSetStart:e[4]||(e[4]=g=>i.datatable.start=g),onSetEnd:e[5]||(e[5]=g=>i.datatable.end=g),table:a.table,column:V,index:a.index,datatable:i.datatable},null,8,["table","column","index","datatable"]))),128))])]),"no-data":l(()=>[y("div",null,m(t.$t("No data found")),1)]),_:2},[w(t.$slots,(s,d)=>({name:d,fn:l(V=>[C(t.$slots,d,z(K(V||{})))])}))]),1032,["items-per-page","sort-by","page","search","headers","items-length","items","loading","loading-text","items-per-page-text","onUpdate:options"])]),_:3})]),_:3})}const kt=O(ut,[["render",ht]]);export{kt as _};
