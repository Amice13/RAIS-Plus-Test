import{_ as E}from"./ImportUploadBox-Cei2uRrf.js";import{_ as j}from"./CustomDate-CfhxorUI.js";import{_ as Q,a as W,b as X}from"./CustomMultipleBundle-B39GX2p6.js";import{_ as Y,d as G,f as K,h as Z}from"./index-Dr3A69Vy.js";import{d as w}from"./xlsx-template-browser-scOJpVFS.js";import{d as ee}from"./dot-object-sCKibp8s.js";import{a9 as C,a3 as f,u as d,a4 as o,a6 as u,W as r,a2 as V,a7 as y,ad as te,Y as h,Q as U,ac as se,S as B,F as H,aa as z}from"./@vue-CVhpfiSJ.js";import{b as A}from"./route-block-B_A1xBdJ.js";import{z as I,A as O,l as P,m as J,R as ae,r as le,S as ie,C as re,n as oe,N as de,O as ne,P as ue,I as me,p as L,f as R,o as pe,q as ce}from"./vuetify-8yKwgmF2.js";import"./joi-BOBjTjze.js";import"./@turf-BykKS3Vs.js";import"./xlsx-CILBIiVl.js";import"./comlink-B8fJUUNV.js";/* empty css             */import"./pinia-DJQ_g8GY.js";import"./pinia-plugin-persistedstate-Bx52SgID.js";import"./destr-BPvN1X9m.js";import"./deep-pick-omit-CegYQlcN.js";import"./pinia-shared-state-C4xqZbDc.js";import"./broadcast-channel-TeH36tNo.js";import"./oblivious-set-DL5W-sud.js";import"./dexie-DU0pVwlp.js";import"./@azure-suSn7m2_.js";import"./bson-objectid-DhxNlv_d.js";import"./vue-i18n-rpOKKwMw.js";import"./@intlify-DAAxr81y.js";import"./axios-xsH4HHeE.js";import"./md5-Ct8Y5Pza.js";import"./crypt-VTvMai_Y.js";import"./charenc-DuOFFKym.js";import"./is-buffer-DMJNLjvk.js";import"./uuid-C6aID195.js";import"./jszip-B9I6jZYU.js";import"./echarts-B3RPNoSA.js";import"./zrender-BxIUiisS.js";import"./@faker-js-9AjqWMS-.js";import"./jwt-decode-VWaDGczM.js";import"./vue-router-V8rnRB0-.js";import"./maska-DMix1GTA.js";var fe={FRONT_HOST:"https://raisplus-test.unhcr.in.ua"};const he={Duplicated:"red-darken-2","This tax ID is invalid":"yellow-darken-2","Planned support":"pink-accent-4",Unique:"green-darken-2","Duplicated family member":"orange-darken-2","Planned support for a family member":"pink-darken-4"},ge=(e,l=1e4)=>Array.from({length:Math.ceil(e.length/l)},(v,b)=>e.slice(b*l,b*l+l)),q={inject:["$error","$loading"],name:"Deduplication",mounted(){this.appStore.loading=!1},computed:{translatedHeaders(){return this.$i18n.locale==="en"?this.headers:JSON.parse(JSON.stringify(this.headers)).map(l=>(l.title=this.$t(l.title),l))},dialog(){return this.currentItem.length>0}},data(){return{search:void 0,loading:!1,dateFilters:{date:{$lte:void 0,$gte:void 0}},filters:{items:{$nested:{key:[]}}},oneRecord:!0,rows:[],results:[],currentItem:[],headers:[{title:"Tax ID",align:"start",value:"taxId",sortable:!0},{title:"Passport",align:"start",value:"passport",sortable:!0},{title:"Result",align:"start",value:"result",sortable:!0},{title:"Date",align:"start",value:"date",sortable:!0},{title:"Bundle name",align:"start",value:"bundleName",sortable:!0},{title:"Organization",align:"start",value:"organization.name"},{title:"Oblast",align:"start",value:"address.pCode1"},{title:"Raion",align:"start",value:"address.pCode2"},{title:"Hromada",align:"start",value:"address.pCode3"},{title:"Locality",align:"start",value:"address.pCode4"}]}},methods:{async checkBulk(e){var _,$,N,s;let l=e.filter(Boolean).map(t=>{if(t=String(t).replace(/[^А-Я\d]/gi,""),/^\d{9}$/.test(t))return{passport:t};if(/^[А-ЯЄІЇ]{2} *\d{6}$/.test(t.toUpperCase()))return{passport:t.toUpperCase().replace(/^([А-Я]{2})(\d{6})/g,"$1 $2")};const m=Z(t);return m?m.result==="warning"?{taxId:t,result:"This tax ID is invalid"}:{taxId:t}:{taxId:t,result:"This tax ID is invalid"}});const v=l.filter(t=>!t.result).map(t=>t.taxId||t.passport).filter(Boolean),{assistances:b}=this.$storage,a=JSON.parse(JSON.stringify(this.filters)),p=[a],g={peopleIds:v};if(($=(_=this.dateFilters)==null?void 0:_.date)!=null&&$.$lte&&(g.date={$lte:this.dateFilters.date.$lte}),(s=(N=this.dateFilters)==null?void 0:N.date)!=null&&s.$gte&&(g.date||(g.date={}),g.date.$gte=this.dateFilters.date.$gte),a.bundleName&&(g.bundleName=a.bundleName),a.distributionModality&&(g.distributionModality=a.distributionModality),!a.distributionModality||a.distributionModality.includes("Cash")||a.distributionModality.includes("Voucher")){const t={value:{$gt:0}};t.distributionModality||delete t.distributionModality,p.push(t)}let i=await b.useIndex("peopleIds").slice(0,1e4).filter(g).sort({date:"desc"}).should(p).include(["headOfHousehold.taxId","headOfHousehold.passport","familyMembers.taxId","familyMembers.passport","date","bundleName","organization.name","admin1","admin2","admin3","admin4","address.pCode1","address.pCode2","address.pCode3","address.pCode4"]).find();return i.count||(this.results=l,this.loading=!1),i.items=i.items.map(t=>ee.object(t)),l=l.map(t=>{var k,c;if(t.result)return t;let m=[];if(t.passport&&(m=i.items.filter(n=>{var D;return((D=n.headOfHousehold)==null?void 0:D.passport)===t.passport})),t.taxId&&(m=i.items.filter(n=>{var D,x,T,F,M;return(D=n.headOfHousehold)!=null&&D.taxId&&((x=n.headOfHousehold)==null?void 0:x.taxId)===t.taxId||(T=n.familyMembers)!=null&&T.map(S=>S.taxId).includes(t.taxId)||(F=n.familyMembers)!=null&&F.map(S=>S.taxId).includes(t.taxId)?!0:n.taxIds&&((M=n.taxIds)==null?void 0:M.includes(t.taxId))})),!m.length)return{...t,result:"Unique"};if(this.oneRecord){let n={...m[0],...t,items:m};return t.taxId&&((k=m[0].headOfHousehold)==null?void 0:k.taxId)===t.taxId||t.passport&&((c=m[0].headOfHousehold)==null?void 0:c.passport)===t.passport?(n.result=new Date(m[0].date)<new Date?"Duplicated":"Planned support",n):(n.result=new Date(m[0].date)<new Date?"Duplicated family member":"Planned support for a family member",n)}return m=m.map(n=>{var D,x;return n={...n,...t,items:[]},t.taxId&&((D=n.headOfHousehold)==null?void 0:D.taxId)===t.taxId||t.passport&&((x=n.headOfHousehold)==null?void 0:x.passport)===t.passport?(n.result=new Date(n.date)<new Date?"Duplicated":"Planned support",n):(n.result=new Date(n.date)<new Date?"Duplicated family member":"Planned support for a family member",n)}),m}).flat(),l},async checkAll(){let e=JSON.parse(JSON.stringify(this.rows));if(Array.isArray(e)||(e=[e]),e.length===1&&!Array.isArray(e[0])&&(e=[e]),e=e.map(a=>a[0]).filter(Boolean),!e.length)return!1;this.loading=!0;const l=ge(e),v=l.length,b=[];for(const a of l){let p=await this.checkBulk(a);v>1&&(p=p.filter(g=>g.result!=="Unique")),b.push(...p)}this.results=b,this.loading=!1},formatDate(e){return e?K(e).toLocaleDateString("uk"):""},getColor(e){return he[e]},getFileName(){var b,a,p,g;const e=((a=(b=this.appStore)==null?void 0:b.user)==null?void 0:a.name)||"User",l=((g=(p=this.appStore)==null?void 0:p.user)==null?void 0:g.email)||"no@email";return`${new Date().toISOString().substring(0,10)} - Deduplication data for ${e} (${l}).xlsx`},exportData(){let e=JSON.parse(JSON.stringify(this.results));const l=["Tax ID","Passport","Result","Date","Bundle name","Organization","Oblast","Raion","Hromada","Locality","pCode1","pCode2","pCode3","pCode4"],v=["taxId","passport","result","date","bundleName","organization.name","admin1","admin2","admin3","admin4","address.pCode1","address.pCode2","address.pCode3","address.pCode4"],b=`${fe.FRONT_HOST}/export/export.xlsx`,a=this.getFileName();e=e.map(i=>{var _;return i.bundleName=this.$t(i.bundleName),(_=i.address)!=null&&_.pCode4&&(i.address.pCode1=i.address.pCode4.substring(0,4),i.address.pCode2=i.address.pCode4.substring(0,6),i.address.pCode3=i.address.pCode4.substring(0,9),i.admin1=i.address.pCode4?this.$t(i.address.pCode4.substring(0,4),"en"):"",i.admin2=i.address.pCode4?this.$t(i.address.pCode4.substring(0,6),"en"):"",i.admin3=i.address.pCode4?this.$t(i.address.pCode4.substring(0,9),"en"):"",i.admin4=i.address.pCode4?this.$t(i.address.pCode4,"en"):""),i});const p=v.map(i=>e.map(_=>G(i,_)));(async()=>await w(b,{headers:l,columns:p},a))()}}},be={class:"guide pa-2"},ye={class:"text-h4 font-weight-bold"},Ce={class:"text-h5 mb-2 offset-md1 black--text"},_e={class:"mt-4"},ve={style:{"white-space":"nowrap"}},ke={sclass:"text-no-wrap"},De={class:"text-no-wrap"},Ie={class:"text-no-wrap"},Ve={class:"d-flex w-100"},$e={class:"bg-blue-grey-lighten-5 pa-4 flex-grow-1"},xe={class:"text-h6 mt-4"},Ne={class:"mb-6 mt-2"},Oe={class:"mt-2 mb-2"},Se={key:0,class:"mt-2 mb-2"},Re={key:1,class:"mt-2 mb-2"},Te={key:2,class:"mt-2 mb-2"},Fe={key:3,class:"mt-2 mb-2"},Me={class:"mt-2 mb-2"},Ue={key:4,class:"mt-2 mb-2"},Be={class:"ml-6"},He={key:5,class:"mt-2 mb-2"};function ze(e,l,v,b,a,p){const g=Q,i=W,_=X,$=j,N=E;return f(),C("div",be,[d(O,{class:"mb-0 mt-0"},{default:o(()=>[d(I,{cols:"12",md:"12",class:"mb-0 mt-0 pb-4 pt-0 pl-md-8 pr-md-8"},{default:o(()=>[u("div",ye,r(e.$t("Deduplication")),1)]),_:1})]),_:1}),d(O,{class:"mb-0 mt-0"},{default:o(()=>[d(I,{cols:"12",md:"12",class:"mb-0 mt-0 pb-0 pt-0 pl-md-8 pr-md-8"},{default:o(()=>[d(P,{class:"pt-sm-4 pb-sm-4 pt-md-16 pb-md-16"},{default:o(()=>[d(J,null,{default:o(()=>[d(O,null,{default:o(()=>[d(I,{cols:"12",md:"3",class:"pl-md-16"},{default:o(()=>{var s,t,m,k;return[u("div",Ce,r(e.$t("Deduplication")),1),u("div",null,r(e.$t("Please specify the necessary filter and provide the list of tax IDs to obtain information regarding the support provided")),1),u("div",_e,[d(ae,{modelValue:a.oneRecord,"onUpdate:modelValue":l[0]||(l[0]=c=>a.oneRecord=c),disabled:a.results.length,label:e.$t("Show only one record per person")},null,8,["modelValue","disabled","label"]),d(g,{modelValue:a.filters.bundleName,"onUpdate:modelValue":l[1]||(l[1]=c=>a.filters.bundleName=c)},null,8,["modelValue"]),d(i,{modelValue:a.filters.distributionModality,"onUpdate:modelValue":l[2]||(l[2]=c=>a.filters.distributionModality=c),class:"mt-4"},null,8,["modelValue"]),((t=(s=a.filters)==null?void 0:s.bundleName)==null?void 0:t.length)===1&&((k=(m=a.filters)==null?void 0:m.distributionModality)==null?void 0:k.length)===1&&a.filters.distributionModality[0]==="In-kind"?(f(),V(_,{key:0,modelValue:a.filters.items.$nested.key,"onUpdate:modelValue":l[3]||(l[3]=c=>a.filters.items.$nested.key=c),bundle:a.filters.bundleName[0],class:"mt-4"},null,8,["modelValue","bundle"])):y("",!0),d($,{modelValue:a.dateFilters.date.$gte,"onUpdate:modelValue":l[4]||(l[4]=c=>a.dateFilters.date.$gte=c),label:e.$t("Start of support"),class:"mt-4"},null,8,["modelValue","label"]),d($,{modelValue:a.dateFilters.date.$lte,"onUpdate:modelValue":l[5]||(l[5]=c=>a.dateFilters.date.$lte=c),label:e.$t("End of support")},null,8,["modelValue","label"])])]}),_:1}),d(I,{cols:"12",md:"9",class:"pr-md-16"},{default:o(()=>[d(O,null,{default:o(()=>[!a.loading&&!a.results.length?(f(),V(I,{key:0,cols:"12"},{default:o(()=>[d(N,{modelValue:a.rows,"onUpdate:modelValue":[l[6]||(l[6]=s=>a.rows=s),p.checkAll],"bundle-name":"none",checkAll:""},null,8,["modelValue","onUpdate:modelValue"])]),_:1})):y("",!0),a.loading?(f(),V(I,{key:1,cols:"12",class:"text-center"},{default:o(()=>[d(le,{color:"primary",indeterminate:"",size:"x-large"})]),_:1})):y("",!0),!a.loading&&a.results.length?(f(),V(I,{key:2,cols:"12",class:"pt-0"},{default:o(()=>[d(ie,{items:a.results,headers:p.translatedHeaders,search:a.search,"no-data-text":e.$t("No data available"),"items-per-page-text":e.$t("Items per page")},{top:o(()=>[U(d(de,{flat:"",color:"white"},{default:o(()=>[d(ne,{style:{"min-width":"150px"}},{default:o(()=>[h(r(e.$t("Results")),1)]),_:1}),d(ue,{class:"mx-4",inset:"",vertical:""}),d(me,{modelValue:a.search,"onUpdate:modelValue":l[7]||(l[7]=s=>a.search=s),class:"mr-4 w-100",variant:"outlined",density:"compact",label:e.$t("Search"),"hide-details":"","prepend-icon":"mdi-magnify"},null,8,["modelValue","label"]),d(L),se(e.$slots,"action-btn",{},()=>[d(R,{onClick:l[8]||(l[8]=s=>a.results=[]),color:"error",variant:"text",class:"mr-2"},{default:o(()=>[h(r(e.$t("Reset")),1)]),_:1}),d(R,{onClick:p.exportData,color:"primary",variant:"tonal"},{default:o(()=>[h(r(e.$t("Export")),1)]),_:1},8,["onClick"])])]),_:3},512),[[B,!e.$vuetify.display.xs]])]),"item.address.pCode1":o(({item:s})=>{var t;return[h(r(((t=s.address)==null?void 0:t.pCode4)&&e.$t(s.address.pCode4.substring(0,4))),1)]}),"item.address.pCode2":o(({item:s})=>{var t;return[h(r(((t=s.address)==null?void 0:t.pCode4)&&e.$t(s.address.pCode4.substring(0,6))),1)]}),"item.address.pCode3":o(({item:s})=>{var t;return[h(r(((t=s.address)==null?void 0:t.pCode4)&&e.$t(s.address.pCode4.substring(0,9))),1)]}),"item.address.pCode4":o(({item:s})=>{var t;return[h(r(((t=s.address)==null?void 0:t.pCode4)&&e.$t(s.address.pCode4)),1)]}),"item.result":o(({item:s})=>[u("span",ve,[d(re,{onClick:t=>a.oneRecord&&(a.currentItem=s.items),class:te({"cursor-pointer":["Duplicated family member","Duplicated"].includes(s.result)}),label:"",color:p.getColor(s.result),variant:"elevated",size:"small"},{default:o(()=>[h(r(e.$t(s.result))+" ",1),["Duplicated family member","Duplicated"].includes(s.result)?(f(),V(oe,{key:0,class:"ml-2"},{default:o(()=>l[10]||(l[10]=[h(" mdi-information ")])),_:1})):y("",!0)]),_:2},1032,["onClick","class","color"])])]),"item.bundleName":o(({item:s})=>[u("span",ke,r(e.$t(s.bundleName)),1)]),"item.organization":o(({item:s})=>{var t;return[u("span",De,r((t=s.organization)==null?void 0:t.name),1)]}),"item.date":o(({item:s})=>[u("span",Ie,r(p.formatDate(s.date)),1)]),_:2},1032,["items","headers","search","no-data-text","items-per-page-text"])]),_:3})):y("",!0)]),_:3})]),_:3})]),_:3})]),_:3})]),_:3})]),_:3})]),_:3}),d(ce,{"model-value":p.dialog},{default:o(()=>[d(P,{title:e.$t("Duplications"),"max-width":"600",class:"margin-auto custom-thumb"},{default:o(()=>[a.currentItem.length?(f(),V(J,{key:0},{default:o(()=>[u("div",Ve,[u("div",$e,[u("div",xe,r(e.$t("Deduplication results")),1),u("div",Ne,[u("div",null,[u("strong",null,r(e.$t("This person has already received the support from humanitarian organizations")),1)])]),(f(!0),C(H,null,z(a.currentItem,s=>{var t,m,k,c;return f(),C("div",{key:s.publicId,class:"mb-7 pl-2",style:{"border-left":"2px solid #039BE5"}},[u("div",Oe,[u("strong",null,r(e.$t("Date"))+":",1),h(" "+r(new Date(s.date).toLocaleDateString("uk")),1)]),s.bundleName?(f(),C("div",Se,[u("strong",null,r(e.$t("Assistance type"))+":",1),h(" "+r(e.$t(s.bundleName)),1)])):y("",!0),(t=s.address)!=null&&t.pCode1?(f(),C("div",Re,[u("strong",null,r(e.$t("Oblast"))+":",1),h(" "+r(e.$t(s.address.pCode1)),1)])):y("",!0),(m=s.address)!=null&&m.pCode2?(f(),C("div",Te,[u("strong",null,r(e.$t("Raion"))+":",1),h(" "+r(e.$t(s.address.pCode2)),1)])):y("",!0),(k=s.address)!=null&&k.pCode4?(f(),C("div",Fe,[u("strong",null,r(e.$t("Locality"))+":",1),h(" "+r(e.$t(s.address.pCode4)),1)])):y("",!0),u("div",Me,[u("strong",null,r(e.$t("Organization"))+":",1),h(" "+r((c=s.organization)==null?void 0:c.name),1)]),s.items&&s.items.length?(f(),C("div",Ue,[u("div",null,[u("strong",null,r(e.$t("Items"))+":",1)]),u("ul",Be,[(f(!0),C(H,null,z(s.items,n=>U((f(),C("li",null,r(e.$t(n.key))+": "+r(n.value),513)),[[B,n.value]])),256))])])):y("",!0),s.value?(f(),C("div",He,[u("strong",null,r(e.$t("Value"))+":",1),h(" "+r(s.value?s.value.toLocaleString("uk-UA",{style:"currency",currency:s.currency||"USD"}):""),1)])):y("",!0)])}),128))])])]),_:1})):y("",!0),d(pe,null,{default:o(()=>[d(L),d(R,{text:e.$t("Close"),color:"primary",onClick:l[9]||(l[9]=s=>a.currentItem=[])},null,8,["text"])]),_:1})]),_:1},8,["title"])]),_:1},8,["model-value"])])}typeof A=="function"&&A(q);const It=Y(q,[["render",ze]]);export{It as default};
