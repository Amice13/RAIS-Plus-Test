import{_,a as $}from"./CustomDistributionModality-CIqFmuFE.js";import{_ as C}from"./ReportsLinks-gB2oq9-e.js";import{_ as N}from"./CustomDate-CLArRqjL.js";import{_ as I}from"./CustomBundle-HZg5QtVE.js";import{_ as L,F as M,o as O,a as i,w as m,x as g,y,z,B as E,ab as k,a9 as B,aV as b}from"./index-BtIo2-Z_.js";import{d as R}from"./index-T2HRTWtS.js";import{b as V}from"./route-block-B_A1xBdJ.js";import{V as f,a as h}from"./VRow-9vAZildp.js";import{V as T,a as U}from"./VCard-DNHZbZ5d.js";import{V as A}from"./filter-ahsWVyiP.js";import{V as F}from"./VCheckbox-Berrf7y1.js";import"./CustomTableHeaderStatic-d1pKQ-ga.js";import"./debouncer-Whu4ZLob.js";import"./index-SDX8Otz2.js";import"./VMenu-Cs322VI3.js";import"./VOverlay-BnbjS8dz.js";import"./forwardRefs--KQCZfKO.js";import"./dialog-transition-Dq7CKyny.js";import"./VBtn--bGuKZaN.js";import"./group-DgRBM2CV.js";import"./VProgressCircular-DNPB7izS.js";import"./VContainer-BFGIFtcM.js";/* empty css              */import"./VTextField-Bn35T3UG.js";import"./index-C5-hvfiu.js";import"./VInput-CRZE-Mt3.js";import"./VImg-FY_z5S7Z.js";import"./VList-Cnqqz-5U.js";import"./VAvatar-l5UJO0sV.js";import"./VChip-CKNl8kC9.js";import"./VSpacer-bp7-SSB-.js";import"./VDataTableVirtual-Cqes2yZi.js";import"./VDataTable-BrBBORsC.js";import"./VPagination-zp71F-1D.js";import"./VCheckboxBtn-DQUGWCnj.js";import"./VTooltip-DXl_TsVy.js";import"./VToolbar-o4oksDe3.js";import"./VAutocomplete-BVJCf0KD.js";var H={FRONT_HOST:"https://raisplus-test.unhcr.in.ua"};const D={name:"reports",beforeMount(){var e,r,a,l,o;const t=localStorage.getItem("unhcr-rais-plus-recent-report");t||(this.filters["organization.id"]=(a=(r=(e=this.appStore)==null?void 0:e.user)==null?void 0:r.organization)==null?void 0:a.id,this.filters.date.$gte=new Date().toLocaleDateString("sv-SE").replace(/-\d+$/,"-01"),this.filters.date.$lte=new Date().toLocaleDateString("sv-SE")),this.organizations=[(o=(l=this.appStore)==null?void 0:l.user)==null?void 0:o.organization].filter(Boolean),t&&Object.assign(this.filters,JSON.parse(t)),this.getFiltersData(),this.appStore.loading=!1},computed:{isAdmin(){var t,e,r;return(r=(e=(t=this.appStore)==null?void 0:t.user)==null?void 0:e.role)==null?void 0:r.includes("Admin")},summaryHeaders(){return[]},indicatorsHeaders(){return[]},requiredFiltersAreSet(){return this.isAdmin?!0:[this.filters["organization.id"],this.filters.bundleName,this.filters.distributionModality].filter(Boolean).length===3}},data:()=>({organizations:[],filters:{"organization.id":void 0,bundleName:"SN101-2024",aor:[],distributionModality:"In-kind",populationType:[],date:{$lte:void 0,$gte:void 0},pCode1:void 0,pCode2:void 0,pCode3:void 0,pCode4:void 0},includeDonations:!1,summary:[],summaryLoading:!0,indicators:[],indicatorsLoading:!0}),methods:{async getFiltersData(){const{organizations:t}=this.$storage,e=await t.slice(0,500).filter({functionalType:["UN Agency","Operational partner","Implementing partner"]}).include(["id","name","translation.uk.name"]).sort([{name:"asc"}]).find();this.organizations=e.items},async getSummary(){if(this.summaryLoading=!0,!this.requiredFiltersAreSet)return this.summaryLoading=!1;let{assistances:t}=this.$storage;t=t.useIndex("bundleName");const e=Object.fromEntries(Object.entries(this.filters).filter(([,a])=>a));t.filter(e);let r=await t.aggregate({groupBy:["date","address.pCode4","collectiveCenter.name","organization.name","publicId"],aggs:{"familyStats.households":{variable:"address.pCode1",operation:"count"},"familyStats.all":{variable:"familyStats.all",operation:"sum"},"familyStats.girls":{variable:"familyStats.girls",operation:"sum"},"familyStats.boys":{variable:"familyStats.boys",operation:"sum"},"familyStats.men":{variable:"familyStats.men",operation:"sum"},"familyStats.women":{variable:"familyStats.women",operation:"sum"},"familyStats.seniorMen":{variable:"familyStats.seniorMen",operation:"sum"},"familyStats.seniorWomen":{variable:"familyStats.seniorWomen",operation:"sum"},"familyStats.disabled":{variable:"familyStats.disabled",operation:"sum"},"familyStats.vulnerable":{variable:"familyStats.vulnerable",operation:"sum"},items:{variable:"items",operation:"nested",nested:{groupBy:["key"],aggs:{value:{variable:"value",operation:"sum"}}}},strings:{variable:"strings",operation:"nested",nested:{groupBy:["key"],aggs:{value:{variable:"value",operation:"count"}}}},value:{variable:"value",operation:"sum"}}});if(r=r.map(a=>{var l,o,s,u,p,d;return a=B.object(a),a.items&&(a.items=b(a.items)),a.strings&&(a.strings=b(a.strings)),a.address.pCode1=(o=(l=a.address)==null?void 0:l.pCode4)==null?void 0:o.substring(0,4),a.address.pCode2=(u=(s=a.address)==null?void 0:s.pCode4)==null?void 0:u.substring(0,6),a.address.pCode3=(d=(p=a.address)==null?void 0:p.pCode4)==null?void 0:d.substring(0,9),a}),this.includeDonations){const a=Object.fromEntries([["bundleName",this.filters.bundleName],["distributionModality",this.filters.distributionModality],["organization.id",this.filters["organization.id"]]].filter(([,s])=>s)),{donations:l}=this.$storage,o=await l.useIndex("bundleName").filter({...a,date:{$lte:this.endDate,$gte:this.startDate}}).include(["publicId","familyStats","items","households","date","address","collectiveCenter"]).find();r.push(...o.items.map(s=>(s.isDonnation=!0,s.items=b(s.items),s.familyStats.households=s.households,s)))}this.summary=r,this.summaryLoading=!1},async getIndicators(){this.indicatorsLoading=!0;let e=(await this.$api.data.getIndicators({startDate:this.startDate,endDate:this.endDate})).data;e=e.map(d=>d);const r=`${H.FRONT_HOST}/export/export.xlsx`,a="Indicators report.xlsx",l=[["orangization","Organisation Name"],["region","Location Region"],["raion","Location Raion"],["hromada","Location Hromada"],["settlement","Location Settlement"],["collectiveCenter","Location Site"],["month","Reporting Month"],["output","Indicators Output"],["indicator","Indicators Indicator"],["nonKit","Kit-NonKit Kit-NonKit"],["populationType","PoC Category PoC Category"],["modality","Modality Modality"],["households","Households"],["girls","GIRLS (<18 years)"],["boys","BOYS (<18 years)"],["women","WOMEN (18-59 years)"],["men","MEN (18-59 years)"],["seniorWomen","ELDERLY WOMEN (60+)"],["seniorMen","ELDERLY MEN (60+)"],["disabled","PEOPLE WITH DISABILITIES"]];this.filters.distributionModality!=="In-kind"&&l.push(["value","Value"]);const o=l.map(d=>d[1]),u=l.map(d=>d[0]).map(d=>e.map(c=>k(d,c)));(async()=>await R(r,{headers:o,columns:u},a))(),this.indicatorsLoading=!1},getData(){this.getSummary()}},watch:{filters:{deep:!0,handler(t){localStorage.setItem("unhcr-rais-plus-recent-report",JSON.stringify(t)),this.getData()}}}},W={class:"reports pa-2"},j={class:"text-h5 mb-2 offset-md1 black--text"},w={class:"text-h5 mb-2 offset-md1 black--text"};function K(t,e,r,a,l,o){const s=I,u=_,p=N,d=C,c=$;return O(),M("div",W,[i(h,{class:"mb-0 mt-0"},{default:m(()=>[i(f,{cols:"12",md:"12",class:"mb-0 mt-0 pb-0 pt-0"},{default:m(()=>[i(T,null,{default:m(()=>[i(U,null,{default:m(()=>[i(h,null,{default:m(()=>[i(f,{cols:"12",md:"3",class:"pl-md-4"},{default:m(()=>[g("div",j,y(t.$t("Filters")),1),g("div",null,y(t.$t("Define the filters for your report")),1),g("div",null,[i(A,{modelValue:t.filters["organization.id"],"onUpdate:modelValue":e[0]||(e[0]=n=>t.filters["organization.id"]=n),label:t.$t("Organization"),items:t.organizations,"item-title":n=>{var S,v;return t.$i18n.locale==="en"?n.name:((v=(S=n.translation)==null?void 0:S[t.$i18n.locale])==null?void 0:v.name)||""},clearable:o.isAdmin,"item-value":"id",class:"mt-4",variant:"underlined"},null,8,["modelValue","label","items","item-title","clearable"]),i(s,{modelValue:t.filters.bundleName,"onUpdate:modelValue":e[1]||(e[1]=n=>t.filters.bundleName=n)},null,8,["modelValue"]),i(u,{class:"mt-4",modelValue:t.filters.distributionModality,"onUpdate:modelValue":e[2]||(e[2]=n=>t.filters.distributionModality=n)},null,8,["modelValue"]),i(p,{modelValue:t.filters.date.$gte,"onUpdate:modelValue":[e[3]||(e[3]=n=>t.filters.date.$gte=n),o.getData],label:t.$t("Start of report period"),class:"mt-4"},null,8,["modelValue","onUpdate:modelValue","label"]),i(p,{modelValue:t.filters.date.$lte,"onUpdate:modelValue":[e[4]||(e[4]=n=>t.filters.date.$lte=n),o.getData],label:t.$t("End of report period")},null,8,["modelValue","onUpdate:modelValue","label"]),z(i(F,{modelValue:t.includeDonations,"onUpdate:modelValue":[e[5]||(e[5]=n=>t.includeDonations=n),o.getData],label:t.$t("Include donations")},null,8,["modelValue","onUpdate:modelValue","label"]),[[E,t.filters.distributionModality==="In-kind"]])])]),_:1}),i(f,{cols:"12",md:"9",class:"pr-md-4"},{default:m(()=>[i(h,null,{default:m(()=>[i(d),i(f,{cols:"12"},{default:m(()=>[g("div",w,y(t.$t("Distribution summary")),1)]),_:1}),i(f,null,{default:m(()=>[i(c,{data:t.summary,filters:t.filters,startDate:t.filters.date.$gte,endDate:t.filters.date.$lte,loading:t.summaryLoading},null,8,["data","filters","startDate","endDate","loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})])}typeof V=="function"&&V(D);const Mt=L(D,[["render",K]]);export{Mt as default};
