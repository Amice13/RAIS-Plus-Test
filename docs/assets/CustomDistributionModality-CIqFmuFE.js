import{_ as Z}from"./CustomTableHeaderStatic-d1pKQ-ga.js";import{_ as L,F as $,o as f,c as N,A as O,w as m,a as g,ae as w,x as A,y as C,C as D,q as ee,G as te,H as z,z as E,B as R,a8 as ae,aW as se,aX as ie,a9 as P,ab as F}from"./index-BtIo2-Z_.js";import{d as de}from"./debouncer-Whu4ZLob.js";import{d as M}from"./index-T2HRTWtS.js";import{V as re}from"./VProgressCircular-DNPB7izS.js";import{V as B}from"./VRow-9vAZildp.js";import{V as oe}from"./VDataTableVirtual-Cqes2yZi.js";import{a as ne,V as T}from"./VBtn--bGuKZaN.js";import{V as le}from"./VTooltip-DXl_TsVy.js";import{V as ue,a as me}from"./VToolbar-o4oksDe3.js";import{d as pe}from"./VList-Cnqqz-5U.js";import{V as ce}from"./VTextField-Bn35T3UG.js";import{V as he}from"./filter-ahsWVyiP.js";const fe=(e,s)=>{const i=document.createElement("a");i.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(s)),i.setAttribute("download",e),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)};var K={FRONT_HOST:"https://raisplus-test.unhcr.in.ua"};const k=["id","createdAt","createdBy","createdByEmail","date","publicId","bundleName","distributionModality","populationType","objectives.clusterObjective","objectives.sectoralObjective","aor","address.id","address.type","address.country.code","address.country.code2","address.country.code3","address.country.name","address.pCode1","address.pCode2","address.pCode3","address.pCode4","address.admin1","address.admin2","address.admin3","address.admin4","collectiveCenter.code","collectiveCenter.name","address.streetType","address.street","address.fullStreet","address.building","address.block","address.apartment","address.fullAddress","address.translation.uk.street","address.translation.uk.building","address.translation.uk.fullAddress","address.location.type","address.location.accuracy","address.location.coordinates.0","address.location.coordinates.1","address.tags","householdId","household.pCode1","household.pCode2","household.pCode3","household.pCode4","household.admin1","household.admin2","household.admin3","household.admin4","household.streetType","household.street","household.fullStreet","household.building","household.block","household.apartment","household.fullAddress","household.translation.uk.street","household.translation.uk.building","household.translation.uk.fullAddress","household.location.type","household.location.accuracy","household.location.coordinates.0","household.location.coordinates.1","household.tags","headOfHouseholdId","headOfHousehold.id","headOfHousehold.taxId","headOfHousehold.populationType","headOfHousehold.noTaxId","headOfHousehold.passport","headOfHousehold.origin","headOfHousehold.familyName","headOfHousehold.givenName","headOfHousehold.additionalName","headOfHousehold.fullName","headOfHousehold.translation.uk.familyName","headOfHousehold.translation.uk.givenName","headOfHousehold.translation.uk.additionalName","headOfHousehold.translation.uk.fullName","headOfHousehold.gender","headOfHousehold.birthday","headOfHousehold.age","headOfHousehold.phone","headOfHousehold.tags","familyMembers","familyStats.boys","familyStats.girls","familyStats.men","familyStats.women","familyStats.seniorMen","familyStats.seniorWomen","familyStats.disabled","familyStats.vulnerable","familyStats.all","organization.id","organization.code","organization.name","organization.translation.uk.name","responsibleOrganization.id","responsibleOrganization.code","responsibleOrganization.name","responsibleOrganization.translation.uk.name","fundedBy.id","fundedBy.code","fundedBy.name","fundedBy.translation.uk.name","tags","createdAt"];function ye(e){return e.map(s=>s.map(String).map(i=>i.replaceAll('"','""')).map(i=>`"${i}"`).join(",")).join(`
`)}const ge={name:"ReportsSummary",inject:["$loading","$error"],props:{data:{type:Array,default:()=>[]},filters:{type:Object,default:()=>({})},startDate:{type:[String,Date]},endDate:{type:[String,Date]},loading:{type:Boolean}},computed:{allowExport(){var e,s,i,n,o,l;return((i=(s=(e=this.appStore)==null?void 0:e.user)==null?void 0:s.role)==null?void 0:i.includes("Admin"))||((l=(o=(n=this.appStore)==null?void 0:n.user)==null?void 0:o.role)==null?void 0:l.includes("Partner IM"))},filteredData(){let e=JSON.parse(JSON.stringify(this.data));if(e=e.map(i=>(i.strings&&(i.strings=Object.fromEntries(Object.entries(i.strings).map(([n,o])=>[n.replace(/\./,"․"),o]))),i.items&&(i.items=Object.fromEntries(Object.entries(i.items).map(([n,o])=>[n.replace(/\./,"․"),o]))),i)),this.datatable.search){const i=new RegExp(this.datatable.search.replace(/[.?*{}\[\]()<>]/g,""),"gi");e=e.filter(n=>{const o=JSON.parse(JSON.stringify(n));return o.admin1=this.$t(o.address.pCode1,this.$i18n.locale),o.admin2=this.$t(o.address.pCode2,this.$i18n.locale),o.admin3=this.$t(o.address.pCode3,this.$i18n.locale),o.admin4=this.$t(o.address.pCode4,this.$i18n.locale),JSON.stringify(o).match(i)})}const s=Object.entries(this.datatable.filters);return s.length&&(e=e.filter(i=>{for(const[n,o]of s)if(!o.includes(F(n,i)))return!1;return!0})),e},strings(){const e=[];for(let s of this.data)if(s.strings)for(let i of Object.keys(s.strings))e.includes(i)||e.push(i);return e},items(){const e=[];for(let s of this.data)if(s.items)for(let i of Object.keys(s.items))e.includes(i)||e.push(i);return e},headers(){var o,l;const e=[{title:"Download",align:"left",value:"_id",sortable:!1},{title:"Date",align:"left",value:"date",sortable:!0},{title:"Organization",align:"left",value:"organization.name",sortable:!0,type:"term"},{title:"Public ID",align:"left",value:"publicId",sortable:!0},{title:"Oblast",align:"left",value:"address.pCode1",sortable:!0,filterable:!0,type:"term"},{title:"Raion",align:"left",value:"address.pCode2",sortable:!0,filterable:!0,type:"term"},{title:"Hromada",align:"left",value:"address.pCode3",sortable:!0,filterable:!0,type:"term"},{title:"Locality",align:"left",value:"address.pCode4",sortable:!0,filterable:!0,type:"term"},{title:"Collective center",align:"left",value:"collectiveCenter.name",sortable:!1,filterable:!0,type:"term"},{title:"Households",align:"center",value:"familyStats.households",sortable:!0},{title:"Individuals",align:"center",value:"familyStats.all",sortable:!0},{title:"Girls (<18)",align:"center",value:"familyStats.girls",sortable:!0},{title:"Boys (<18)",align:"center",value:"familyStats.boys",sortable:!0},{title:"Women (18-59)",align:"center",value:"familyStats.women",sortable:!0},{title:"Men (18-59)",align:"center",value:"familyStats.men",sortable:!0},{title:"Elderly women (60+)",align:"center",value:"familyStats.seniorWomen",sortable:!0},{title:"Elderly men (60+)",align:"center",value:"familyStats.seniorMen",sortable:!0},{title:"People with disabilities",align:"center",value:"familyStats.disabled",sortable:!0},{title:"Vulnerable people",align:"center",value:"familyStats.vulnerable",sortable:!0}],s=this.items.map(u=>({title:u,align:"center",value:`items.${u.replace(/\./,"․")}`})),i=this.strings.map(u=>({title:u,align:"center",value:`strings.${u.replace(/\․/,".")}`})),n=(l=(o=this.items)==null?void 0:o[0])!=null&&l.value?[{title:"Value",align:"center",value:"value",sortable:!0}]:[];return[...e,...s,...i,...n]}},data:()=>({search:void 0,index:"publicId",datatable:{search:"",searchKeys:[],start:void 0,end:void 0,filters:{},sortBy:[{date:"asc"}]}}),methods:{setSearch:de(function(e){this.datatable.search=e}),setFilter(e){this.datatable.filters=e},getFileName(){var i,n,o,l;const e=((n=(i=this.appStore)==null?void 0:i.user)==null?void 0:n.name)||"User",s=((l=(o=this.appStore)==null?void 0:o.user)==null?void 0:l.email)||"no@email";return`${new Date().toISOString().substring(0,10)} - Distribution summary ${e} (${s}).xlsx`},exportData(){let e=JSON.parse(JSON.stringify(this.filteredData));const s=`${K.FRONT_HOST}/export/export.xlsx`,i=this.getFileName(),n=this.headers.map(t=>t.title).filter(t=>t!=="Download");n.push("P-Code 1","P-Code 2","P-Code 3","P-Code 4");const o=this.headers.map(t=>t.value).filter(t=>t!=="_id");o.push("pCode1","pCode2","pCode3","pCode4"),e=e.map(t=>(t.date=new Date(t.date),t.pCode1=t.address.pCode1,t.pCode2=t.address.pCode2,t.pCode3=t.address.pCode3,t.pCode4=t.address.pCode4,t.address.pCode1=this.$t(t.address.pCode1,"en"),t.address.pCode2=this.$t(t.address.pCode2,"en"),t.address.pCode3=this.$t(t.address.pCode3,"en"),t.address.pCode4=this.$t(t.address.pCode4,"en"),t));const l=o.map(t=>e.map(a=>F(t,a)));(async()=>await M(s,{headers:n,columns:l},i))()},async exportRaw(){const e=JSON.parse(JSON.stringify(this.filters));for(const a of Object.keys(e))e[a]===void 0&&delete e[a],e[a]===null&&delete e[a],Array.isArray(e[a])&&e[a].length===0&&delete e[a];this.$loading(!0);const{assistances:s}=this.$storage;e.date={$gte:this.startDate,$lte:this.endDate};let n=(await s.useIndex("date").filter(e).sort("createdAt").slice(0,1e4).include([...k,"items","strings"]).export()).items;if(!n.length)return this.$loading(!1),alert("No data");n[0].date,n=n.map(a=>(a.address&&(a.address.admin1=this.$t(a.address.pCode1||"","en")+" oblast",a.address.admin2=this.$t(a.address.pCode2||"","en")+" raion",a.address.admin3=this.$t(a.address.pCode3||"","en")+" hromada",a.address.admin4=this.$t(a.address.pCode4||"","en"),a.address.fullStreet=[a.address.streetType,a.address.street,a.address.building].filter(Boolean).join(" ")),a.birthday&&(a.birthday=new Date(a.birthday)),a.items&&(a.items=Object.fromEntries(a.items.map(({key:p,value:c})=>[p,c]))),a));let o=JSON.parse(JSON.stringify(this.items||[])).sort().map(a=>`items.${a}`),l=JSON.parse(JSON.stringify(this.strings||[])).sort().map(a=>`strings.${a}`);const u=JSON.parse(JSON.stringify(k));u.splice(97,0,...o),u.splice(97,0,...l),n=n.map(a=>P.dot(a));const t=n.slice(1).map(a=>u.map(p=>a[p]??""));fe(new Date().toISOString()+" - Export "+(this.filters.bundleName||"all")+".csv",ye([u,...t])),this.$loading(!1)},async getRawData(e){this.$loading(!0);const s=await this.$api.external.getRawData(e);s.Table1||(this.$loading(!1),await this.$error({title:this.$t("You can't access the distribution list")}));let i=s.Table1;return i=i.map(n=>JSON.parse(n.JSON)),this.$loading(!1),i},async createXLSX(e){var y;let s=[];const{assistances:i}=this.$storage,n=["organization.name","address.pCode4","collectiveCenter.name","date"].reduce((d,r)=>(e[r]&&(d[r]=e[r]),d),{});s=(await i.useIndex("address.pCode4").filter(n).include([...k,"items","strings"]).find()).items;const l=s[0].date,u=this.$t(s[0].address.pCode4,"en"),t=`${l} - Distribution list for ${u} (${s[0].address.pCode4}) by ${((y=s[0].organization)==null?void 0:y.name)||""}.xlsx`;s=s.map(d=>{var r,b,S,h,v;return d.address&&(d.address.admin1=this.$t(d.address.pCode1||"","en")+" oblast",d.address.admin2=this.$t(d.address.pCode2||"","en")+" raion",d.address.admin3=this.$t(d.address.pCode3||"","en")+" hromada",d.address.admin4=this.$t(d.address.pCode4||"","en"),d.address.fullStreet=[d.address.streetType,d.address.street,d.address.building].filter(Boolean).join(" ")),Array.isArray(d.tags)&&(d.tags=d.tags.join(", ")),Array.isArray((r=d.headOfHousehold)==null?void 0:r.phone)&&(d.headOfHousehold.phone=d.headOfHousehold.phone.join(", ")),Array.isArray((b=d.headOfHousehold)==null?void 0:b.tags)&&(d.headOfHousehold.tags=d.headOfHousehold.tags.join(", ")),Array.isArray((S=d.address)==null?void 0:S.tags)&&(d.address.tags=d.address.tags.join(", ")),Array.isArray((h=d.household)==null?void 0:h.tags)&&(d.household.tags=d.household.tags.join(", ")),Array.isArray((v=d.headOfHousehold)==null?void 0:v.tags)&&(d.headOfHousehold.tags=d.headOfHousehold.tags.join(", ")),d.birthday&&(d.birthday=new Date(d.birthday)),d.items&&(d.items=Object.fromEntries(d.items.map(({key:j,value:_})=>[j,_]))),d}),s=s.map(d=>P.dot(d));let a=JSON.parse(JSON.stringify(this.items||[])).sort().map(d=>`items.${d}`),p=JSON.parse(JSON.stringify(this.strings||[])).sort().map(d=>`strings.${d}`);const c=JSON.parse(JSON.stringify(k));c.splice(97,0,...a),c.splice(97,0,...p);const H=c.map(d=>s.map(r=>r[d])),V=`${K.FRONT_HOST}/export/export.xlsx`;(async()=>await M(V,{headers:c,columns:H},t))()},async createPdf(e){let s=[];const{assistances:i}=this.$storage;s=(await i.useIndex("publicId").filter({publicId:e}).include([...k,"items","strings"]).find()).items;const o=s[0].organization;let l="";if(s[0].address){const r=s[0].address,b=[r.building,r.street,r.streetType].filter(Boolean).join(" "),S=[this.$t(r.pCode4||"","en"),this.$t(r.pCode3||"","en")+" hromada",this.$t(r.pCode2||"","en")+" raion",this.$t(r.pCode1||"","en")+" oblast"].filter(Boolean).join(", ");l=[b,S].filter(Boolean).join(", ")}const u=new Date(s[0].date).toLocaleDateString("uk"),t=s[0].createdBy.name,a=s.reduce((r,b)=>{let{items:S}=b;for(let h of Object.keys(S))r[h]||(r[h]=0),r[h]=r[h]+S[h];return r},{}),p=Object.entries(a).filter(([r,b])=>b>0).map(r=>r[0]),c=s.map((r,b)=>{const S=r.taxId?r.taxId:r.passport||"";let h=r.familyName,v=r.givenName;if(!h||!v){let x=(r.name||" ").split(/ /);h=x[0]||"",v=x[1]||""}const j=r.phone&&r.phone.length?r.phone[0]:"",_=r.familyStats.girls||"",U=r.familyStats.boys||"",W=r.familyStats.men||"",X=r.familyStats.women||"",q=r.familyStats.seniorMen||"",G=r.familyStats.seniorWomen||"";let Y=p?p==null?void 0:p.map(x=>{var J;return((J=r==null?void 0:r.items)==null?void 0:J[x])||""}):[];const Q=r.comment?r.comment:"";return[b+1,h,v,S,j,U,_,W,X,q,G,...Y,"",Q]}),H=await this.$db.templates.get("distribution.json"),{file:V}=H,I=new TextDecoder("utf-8"),y=JSON.parse(I.decode(V));y.header[0].text[1]=o,y.header[1].text[1]=l,y.header[2].text[1]=u,y.content[1].text[1]=t,y.content[0].table.widths.splice(11,1,...p.map(r=>12)),y.content[0].table.body[0].splice(11,1,...p.map(r=>({rowSpan:3,height:60,svg:`
          <svg><text text-anchor="middle" transform="translate(7, 30) rotate(-90)" style="font-size: 6.5px;">${r}</text></svg>`}))),y.content[0].table.body.push(...c);const d=`${u} - Distribution list ${s[0].publicId}.pdf`;this.$pdfMake.createPdf(y).download(d)}}},be={class:"report-summary"},Ce={class:"text-no-wrap"},Se={key:0},Oe={key:0},$e={key:0},ve={key:0};function Ne(e,s,i,n,o,l){const u=Z;return f(),$("div",be,[i.loading?(f(),N(B,{key:0,class:"text-center"},{default:m(()=>[g(re,{size:"48",indeterminate:"",color:"primary"})]),_:1})):O("",!0),i.loading?O("",!0):(f(),N(B,{key:1},{default:m(()=>[g(oe,{"sort-by":e.datatable.sortBy,"onUpdate:sortBy":s[3]||(s[3]=t=>e.datatable.sortBy=t),"items-per-page":0,height:e.$vuetify.display.height-390<320?320:e.$vuetify.display.height-390,headers:l.headers,items:l.filteredData,loading:i.loading,"loading-text":e.$t("Loading... Please wait"),"items-per-page-text":e.$t("Records per page"),"item-value":"_id","hide-default-footer":""},w({top:m(()=>[E(g(ue,{flat:"",color:"white"},{default:m(()=>[g(me,{style:{"min-width":"150px"}},{default:m(()=>[D(C(e.$t("Summary")),1)]),_:1}),g(pe,{class:"mx-4",inset:"",vertical:""}),g(ce,{modelValue:e.search,"onUpdate:modelValue":[s[0]||(s[0]=t=>e.search=t),l.setSearch],class:"mr-4 w-100",variant:"outlined",density:"compact",label:e.$t("Search"),"hide-details":"","prepend-icon":"mdi-magnify"},null,8,["modelValue","onUpdate:modelValue","label"])]),_:1},512),[[R,!e.$vuetify.display.xs]])]),headers:m(({columns:t,toggleSort:a})=>[A("tr",null,[(f(!0),$(te,null,z(t,p=>(f(),N(u,{key:p.key,onSetSort:s[1]||(s[1]=c=>e.datatable.sortBy=[c]),onSetFilter:s[2]||(s[2]=c=>l.setFilter(c)),column:p,"parent-items":l.filteredData,datatable:e.datatable},null,8,["column","parent-items","datatable"]))),128))])]),"item._id":m(({item:t})=>[g(ne,null,{default:m(()=>[g(le,{text:e.$t("Export to Excel")},{activator:m(({props:a})=>[t.isDonnation?O("",!0):(f(),N(T,ee({key:0},a,{onClick:p=>l.createXLSX(t),size:"small",rounded:"2",variant:"text",color:"green-darken-2",icon:"mdi-file-excel-box"}),null,16,["onClick"]))]),_:2},1032,["text"])]),_:2},1024)]),"item.publicId":m(({item:t})=>[A("strong",Ce,C(t.publicId),1)]),"item.address.pCode1":m(({item:t})=>{var a;return[(a=t.address)!=null&&a.pCode4?(f(),$("span",Se,C(e.$t(t.address.pCode4.substring(0,4))),1)):O("",!0)]}),"item.address.pCode2":m(({item:t})=>{var a;return[(a=t.address)!=null&&a.pCode4?(f(),$("span",Oe,C(e.$t(t.address.pCode4.substring(0,6))),1)):O("",!0)]}),"item.address.pCode3":m(({item:t})=>{var a;return[(a=t.address)!=null&&a.pCode4?(f(),$("span",$e,C(e.$t(t.address.pCode4.substring(0,9))),1)):O("",!0)]}),"item.address.pCode4":m(({item:t})=>{var a;return[(a=t.address)!=null&&a.pCode4?(f(),$("span",ve,C(e.$t(t.address.pCode4)),1)):O("",!0)]}),"item.date":m(({item:t})=>[D(C(new Date(t.date).toLocaleDateString("uk")),1)]),"no-data":m(()=>[A("div",null,C(e.$t("No data found")),1)]),_:2},[z(e.$slots,(t,a)=>({name:a,fn:m(p=>[ae(e.$slots,a,se(ie(p||{})))])}))]),1032,["sort-by","height","headers","items","loading","loading-text","items-per-page-text"])]),_:3})),i.loading?O("",!0):(f(),N(B,{key:2,class:"text-right"},{default:m(()=>[E(g(T,{onClick:l.exportRaw,class:"mr-2","prepend-icon":"mdi-download",color:"secondary"},{default:m(()=>[D(C(e.$t("Export raw")),1)]),_:1},8,["onClick"]),[[R,l.allowExport]]),g(T,{onClick:l.exportData,color:"primary"},{default:m(()=>[D(C(e.$t("Export")),1)]),_:1},8,["onClick"])]),_:1}))])}const Me=L(ge,[["render",Ne]]),ke=["In-kind","Cash","Voucher"],xe={name:"CustomDistributionModality",props:{modelValue:{type:String},disabled:{type:Boolean}},computed:{model:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}},items(){return ke}}},De={class:"distribution-modality"};function He(e,s,i,n,o,l){return f(),$("div",De,[g(he,{modelValue:l.model,"onUpdate:modelValue":s[0]||(s[0]=u=>l.model=u),label:e.$t("Assistance modality"),items:l.items,"item-title":u=>u?e.$t(u):"","item-value":u=>u,"no-data-text":e.$t("No data available"),variant:"underlined","hide-details":"auto",clearable:""},null,8,["modelValue","label","items","item-title","item-value","no-data-text"])])}const Ke=L(xe,[["render",He]]);export{Ke as _,Me as a};
