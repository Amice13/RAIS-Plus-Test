import{_ as oe}from"./CustomTableHeaderStatic--V9Vxjnk.js";import{_ as J,a6 as j,a5 as B,o as g,F as v,c as k,w as m,a as p,B as C,aa as re,x as z,C as A,A as h,y as x,z as N,G as ne,H as Y,n as de,a4 as le,aL as ue,aM as me,ab as M}from"./index-BYWsBYtF.js";import{d as pe}from"./debouncer-Whu4ZLob.js";import{d as U}from"./index-D0pvfY44.js";import{a as ce,b as fe,V as L}from"./VBtn-DEU8AXzn.js";import{V as O,a as P}from"./VRow-D5QUgmxK.js";import{V as he}from"./VDataTableVirtual-BO58bCzO.js";import{V as ge,a as ye}from"./VToolbar-Jw3O4Zrq.js";import{d as be}from"./VList-wnBQ6eUC.js";import{V as Se}from"./VTextField-CLSPMm7c.js";import{V as $e}from"./VTooltip-CKohhaj7.js";import{_ as Oe}from"./CustomDate-BvE_k-Ie.js";import{V as X}from"./filter-5KaMYqe0.js";import{_ as Ce}from"./CustomBundle-pHbbXnxx.js";import{b as W}from"./route-block-B_A1xBdJ.js";import{V as ve,a as Ae}from"./VCard-C8It3tDs.js";import{V as Ne}from"./VCheckbox-CLjkCuK4.js";import{V as R}from"./VChip-BnTEbD1P.js";import"./index-CqdMy8lr.js";import"./VMenu-BAWQ3Wct.js";import"./VOverlay-uyg0Ioz0.js";import"./forwardRefs-D3j0TLhE.js";import"./dialog-transition-CdzLxCw9.js";import"./VContainer-rOsYQHyZ.js";/* empty css              */import"./VSpacer-D4hnwTqC.js";import"./VAvatar-Bm8XvpvO.js";import"./VImg-wiXIkP7s.js";import"./group-BcbT0sDe.js";import"./VDataTable-DS7yi-Dm.js";import"./VPagination-BBLVO-bG.js";import"./VCheckboxBtn-B1hdxoeT.js";import"./VInput-CwTs2RKk.js";import"./index-bmXFo_Al.js";const De=(e,t)=>{const s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),s.setAttribute("download",e),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)};var G={IS_TEST:!0,FRONT_HOST:"https://raisplus-test.unhcr.in.ua",STATIC_ASSETS_PATH:"http://localhost:3000/static/",MS_APP_CLIENT_ID:"4f92930c-13d8-4c36-95d6-2f2d31727e6e",MS_APP_AUTHORITY:"https://login.microsoftonline.com/e5c37981-6664-4134-8a0c-6543d2af80be",BYPASS_MSAL:!0,LOCALE:"uk-ua",LANGUAGE:"uk",BACKEND_HOST:"http://localhost:3000/api/v1",APP_NAME:"rais-plus",APP_SHORTNAME:"RAIS+",APP_FULLNAME:"RAIS+ Ukraine Assistance Monitoring System",APP_DEFAULT_THEME:"gsc",APP_KEY:"UicablEChAKeyNOmerYONYmIkIMELACIstioNIUMItIcARterm"};const V=["id","createdAt","createdBy","createdByEmail","date","publicId","bundleName","distributionModality","populationType","objectives.clusterObjective","objectives.sectoralObjective","aor","address.id","address.type","address.country.code","address.country.code2","address.country.code3","address.country.name","address.pCode1","address.pCode2","address.pCode3","address.pCode4","address.admin1","address.admin2","address.admin3","address.admin4","collectiveCenter.code","collectiveCenter.name","address.streetType","address.street","address.fullStreet","address.building","address.block","address.apartment","address.fullAddress","address.translation.uk.street","address.translation.uk.building","address.translation.uk.fullAddress","address.location.type","address.location.accuracy","address.location.coordinates.0","address.location.coordinates.1","address.tags","householdId","household.pCode1","household.pCode2","household.pCode3","household.pCode4","household.admin1","household.admin2","household.admin3","household.admin4","household.streetType","household.street","household.fullStreet","household.building","household.block","household.apartment","household.fullAddress","household.translation.uk.street","household.translation.uk.building","household.translation.uk.fullAddress","household.location.type","household.location.accuracy","household.location.coordinates.0","household.location.coordinates.1","household.tags","headOfHouseholdId","headOfHousehold.id","headOfHousehold.taxId","headOfHousehold.populationType","headOfHousehold.noTaxId","headOfHousehold.passport","headOfHousehold.origin","headOfHousehold.familyName","headOfHousehold.givenName","headOfHousehold.additionalName","headOfHousehold.fullName","headOfHousehold.translation.uk.familyName","headOfHousehold.translation.uk.givenName","headOfHousehold.translation.uk.additionalName","headOfHousehold.translation.uk.fullName","headOfHousehold.gender","headOfHousehold.birthday","headOfHousehold.age","headOfHousehold.phone","headOfHousehold.tags","familyMembers","familyStats.boys","familyStats.girls","familyStats.men","familyStats.women","familyStats.seniorMen","familyStats.seniorWomen","familyStats.disabled","familyStats.vulnerable","familyStats.all","organization.id","organization.code","organization.name","organization.translation.uk.name","responsibleOrganization.id","responsibleOrganization.code","responsibleOrganization.name","responsibleOrganization.translation.uk.name","fundedBy.id","fundedBy.code","fundedBy.name","fundedBy.translation.uk.name","tags","createdAt"],q=async(e,t,s,i,d=[])=>{const{assistances:n}=e.$storage;t.date={$gte:s,$lte:i};const l=await n.useIndex("date").filter(t).sort("createdAt").slice(0,1e4).include([...V,"items","strings"]).find(),{count:a,items:u}=l;if(d.push(...u),console.log(a),a<1e4)return d;let c=u[u.length-1].createdAt;return await q(e,t,c,i,d)};function _e(e){return e.map(t=>t.map(String).map(s=>s.replaceAll('"','""')).map(s=>`"${s}"`).join(",")).join(`
`)}const Ie={name:"ReportsSummary",inject:["$loading","$error"],props:{data:{type:Array,default:()=>[]},filters:{type:Object,default:()=>({})},startDate:{type:[String,Date]},endDate:{type:[String,Date]},loading:{type:Boolean}},computed:{idAdmin(){var e,t,s;return(s=(t=(e=this.appStore)==null?void 0:e.user)==null?void 0:t.role)==null?void 0:s.includes("Admin")},filteredData(){let e=JSON.parse(JSON.stringify(this.data));if(e=e.map(s=>(s.strings&&(s.strings=Object.fromEntries(Object.entries(s.strings).map(([i,d])=>[i.replace(/\./,"․"),d]))),s.items&&(s.items=Object.fromEntries(Object.entries(s.items).map(([i,d])=>[i.replace(/\./,"․"),d]))),s)),this.datatable.search){const s=new RegExp(this.datatable.search.replace(/[.?*{}\[\]()<>]/g,""),"gi");e=e.filter(i=>{const d=JSON.parse(JSON.stringify(i));return d.admin1=this.$t(d.address.pCode1,this.$i18n.locale),d.admin2=this.$t(d.address.pCode2,this.$i18n.locale),d.admin3=this.$t(d.address.pCode3,this.$i18n.locale),d.admin4=this.$t(d.address.pCode4,this.$i18n.locale),JSON.stringify(d).match(s)})}const t=Object.entries(this.datatable.filters);return t.length&&(e=e.filter(s=>{for(const[i,d]of t)if(!d.includes(j(i,s)))return!1;return!0})),e},strings(){const e=[];for(let t of this.data)if(t.strings)for(let s of Object.keys(t.strings))e.includes(s)||e.push(s);return e},items(){const e=[];for(let t of this.data)if(t.items)for(let s of Object.keys(t.items))e.includes(s)||e.push(s);return e},headers(){var d,n;const e=[{title:"Download",align:"left",value:"_id",sortable:!1},{title:"Date",align:"left",value:"date",sortable:!0},{title:"Organization",align:"left",value:"organization.name",sortable:!0,type:"term"},{title:"Public ID",align:"left",value:"publicId",sortable:!0},{title:"Oblast",align:"left",value:"address.pCode1",sortable:!0,filterable:!0,type:"term"},{title:"Raion",align:"left",value:"address.pCode2",sortable:!0,filterable:!0,type:"term"},{title:"Hromada",align:"left",value:"address.pCode3",sortable:!0,filterable:!0,type:"term"},{title:"Locality",align:"left",value:"address.pCode4",sortable:!0,filterable:!0,type:"term"},{title:"Collective center",align:"left",value:"collectiveCenter.name",sortable:!1,filterable:!0,type:"term"},{title:"Households",align:"center",value:"familyStats.households",sortable:!0},{title:"Individuals",align:"center",value:"familyStats.all",sortable:!0},{title:"Girls (<18)",align:"center",value:"familyStats.girls",sortable:!0},{title:"Boys (<18)",align:"center",value:"familyStats.boys",sortable:!0},{title:"Women (18-59)",align:"center",value:"familyStats.women",sortable:!0},{title:"Men (18-59)",align:"center",value:"familyStats.men",sortable:!0},{title:"Elderly women (60+)",align:"center",value:"familyStats.seniorWomen",sortable:!0},{title:"Elderly men (60+)",align:"center",value:"familyStats.seniorMen",sortable:!0},{title:"People with disabilities",align:"center",value:"familyStats.disabled",sortable:!0},{title:"Vulnerable people",align:"center",value:"familyStats.vulnerable",sortable:!0}],t=this.items.map(l=>({title:l,align:"center",value:`items.${l.replace(/\./,"․")}`})),s=this.strings.map(l=>({title:l,align:"center",value:`strings.${l.replace(/\․/,".")}`})),i=(n=(d=this.items)==null?void 0:d[0])!=null&&n.value?[{title:"Value",align:"center",value:"value",sortable:!0}]:[];return[...e,...t,...s,...i]}},data:()=>({search:void 0,index:"publicId",datatable:{search:"",searchKeys:[],start:void 0,end:void 0,filters:{},sortBy:[{date:"asc"}]}}),methods:{setSearch:pe(function(e){this.datatable.search=e}),setFilter(e){this.datatable.filters=e},getFileName(){var s,i,d,n;const e=((i=(s=this.appStore)==null?void 0:s.user)==null?void 0:i.name)||"User",t=((n=(d=this.appStore)==null?void 0:d.user)==null?void 0:n.email)||"no@email";return`${new Date().toISOString().substring(0,10)} - Distribution summary ${e} (${t}).xlsx`},exportData(){let e=JSON.parse(JSON.stringify(this.filteredData));const t=`${G.FRONT_HOST}/export/export.xlsx`,s=this.getFileName(),i=this.headers.map(a=>a.title).filter(a=>a!=="Download"),d=this.headers.map(a=>a.value).filter(a=>a!=="_id");e=e.map(a=>(a.address.pCode1=this.$t(a.address.pCode1,"en"),a.address.pCode2=this.$t(a.address.pCode2,"en"),a.address.pCode3=this.$t(a.address.pCode3,"en"),a.address.pCode4=this.$t(a.address.pCode4,"en"),a));const n=d.map(a=>e.map(u=>j(a,u)));(async()=>await U(t,{headers:i,columns:n},s))()},async exportRaw(){const e=JSON.parse(JSON.stringify(this.filters));for(const a of Object.keys(e))e[a]===void 0&&delete e[a],e[a]===null&&delete e[a],Array.isArray(e[a])&&e[a].length===0&&delete e[a];this.$loading(!0);let t=await q(this,e,this.startDate,this.endDate);if(!t.length)return this.$loading(!1),alert("No data");`${t[0].date}${t[0].publicId}`,t=t.map(a=>(a.address&&(a.address.admin1=this.$t(a.address.pCode1||"","en")+" oblast",a.address.admin2=this.$t(a.address.pCode2||"","en")+" raion",a.address.admin3=this.$t(a.address.pCode3||"","en")+" hromada",a.address.admin4=this.$t(a.address.pCode4||"","en"),a.address.fullStreet=[a.address.streetType,a.address.street,a.address.building].filter(Boolean).join(" ")),a.birthday&&(a.birthday=new Date(a.birthday)),a.items&&(a.items=Object.fromEntries(a.items.map(({key:u,value:c})=>[u,c]))),a));let i=JSON.parse(JSON.stringify(this.items||[])).sort().map(a=>`items.${a}`),d=JSON.parse(JSON.stringify(this.strings||[])).sort().map(a=>`strings.${a}`);const n=JSON.parse(JSON.stringify(V));n.splice(97,0,...i),n.splice(97,0,...d),t=t.map(a=>B.dot(a));const l=t.slice(1).map(a=>n.map(u=>a[u]??""));De(new Date().toISOString()+" - Export "+this.filters.bundleName+".csv",_e([n,...l])),this.$loading(!1)},async getRawData(e){this.$loading(!0);const t=await this.$api.external.getRawData(e);t.Table1||(this.$loading(!1),await this.$error({title:this.$t("You can't access the distribution list")}));let s=t.Table1;return s=s.map(i=>JSON.parse(i.JSON)),this.$loading(!1),s},async createXLSX(e){var b;let t=[];const{assistances:s}=this.$storage,i=["organization.name","address.pCode4","collectiveCenter.name","date"].reduce((o,r)=>(e[r]&&(o[r]=e[r]),o),{});t=(await s.useIndex("address.pCode4").filter(i).include([...V,"items","strings"]).find()).items;const n=t[0].date,l=this.$t(t[0].address.pCode4,"en"),a=`${n} - Distribution list for ${l} (${t[0].address.pCode4}) by ${((b=t[0].organization)==null?void 0:b.name)||""}.xlsx`;t=t.map(o=>{var r,S,$,y,I;return o.address&&(o.address.admin1=this.$t(o.address.pCode1||"","en")+" oblast",o.address.admin2=this.$t(o.address.pCode2||"","en")+" raion",o.address.admin3=this.$t(o.address.pCode3||"","en")+" hromada",o.address.admin4=this.$t(o.address.pCode4||"","en"),o.address.fullStreet=[o.address.streetType,o.address.street,o.address.building].filter(Boolean).join(" ")),Array.isArray(o.tags)&&(o.tags=o.tags.join(", ")),Array.isArray((r=o.headOfHousehold)==null?void 0:r.phone)&&(o.headOfHousehold.phone=o.headOfHousehold.phone.join(", ")),Array.isArray((S=o.headOfHousehold)==null?void 0:S.tags)&&(o.headOfHousehold.tags=o.headOfHousehold.tags.join(", ")),Array.isArray(($=o.address)==null?void 0:$.tags)&&(o.address.tags=o.address.tags.join(", ")),Array.isArray((y=o.household)==null?void 0:y.tags)&&(o.household.tags=o.household.tags.join(", ")),Array.isArray((I=o.headOfHousehold)==null?void 0:I.tags)&&(o.headOfHousehold.tags=o.headOfHousehold.tags.join(", ")),o.birthday&&(o.birthday=new Date(o.birthday)),o.items&&(o.items=Object.fromEntries(o.items.map(({key:E,value:H})=>[E,H]))),o}),t=t.map(o=>B.dot(o));let u=JSON.parse(JSON.stringify(this.items||[])).sort().map(o=>`items.${o}`),c=JSON.parse(JSON.stringify(this.strings||[])).sort().map(o=>`strings.${o}`);const f=JSON.parse(JSON.stringify(V));f.splice(97,0,...u),f.splice(97,0,...c);const D=f.map(o=>t.map(r=>r[o])),_=`${G.FRONT_HOST}/export/export.xlsx`;(async()=>await U(_,{headers:f,columns:D},a))()},async createPdf(e){let t=[];const{assistances:s}=this.$storage;t=(await s.useIndex("publicId").filter({publicId:e}).include([...V,"items","strings"]).find()).items;const d=t[0].organization;let n="";if(t[0].address){const r=t[0].address,S=[r.building,r.street,r.streetType].filter(Boolean).join(" "),$=[this.$t(r.pCode4||"","en"),this.$t(r.pCode3||"","en")+" hromada",this.$t(r.pCode2||"","en")+" raion",this.$t(r.pCode1||"","en")+" oblast"].filter(Boolean).join(", ");n=[S,$].filter(Boolean).join(", ")}const l=new Date(t[0].date).toLocaleDateString("uk"),a=t[0].createdBy.name,u=t.reduce((r,S)=>{let{items:$}=S;for(let y of Object.keys($))r[y]||(r[y]=0),r[y]=r[y]+$[y];return r},{}),c=Object.entries(u).filter(([r,S])=>S>0).map(r=>r[0]),f=t.map((r,S)=>{const $=r.taxId?r.taxId:r.passport||"";let y=r.familyName,I=r.givenName;if(!y||!I){let T=(r.name||" ").split(/ /);y=T[0]||"",I=T[1]||""}const E=r.phone&&r.phone.length?r.phone[0]:"",H=r.familyStats.girls||"",Q=r.familyStats.boys||"",Z=r.familyStats.men||"",ee=r.familyStats.women||"",te=r.familyStats.seniorMen||"",ae=r.familyStats.seniorWomen||"";let se=c?c==null?void 0:c.map(T=>{var K;return((K=r==null?void 0:r.items)==null?void 0:K[T])||""}):[];const ie=r.comment?r.comment:"";return[S+1,y,I,$,E,Q,H,Z,ee,te,ae,...se,"",ie]}),D=await this.$db.templates.get("distribution.json"),{file:_}=D,F=new TextDecoder("utf-8"),b=JSON.parse(F.decode(_));b.header[0].text[1]=d,b.header[1].text[1]=n,b.header[2].text[1]=l,b.content[1].text[1]=a,b.content[0].table.widths.splice(11,1,...c.map(r=>12)),b.content[0].table.body[0].splice(11,1,...c.map(r=>({rowSpan:3,height:60,svg:`
          <svg><text text-anchor="middle" transform="translate(7, 30) rotate(-90)" style="font-size: 6.5px;">${r}</text></svg>`}))),b.content[0].table.body.push(...f);const o=`${l} - Distribution list ${t[0].publicId}.pdf`;this.$pdfMake.createPdf(b).download(o)}}},ke={class:"report-summary"},Ve={class:"text-no-wrap"},Te={key:0},Ee={key:0},He={key:0},Me={key:0};function Le(e,t,s,i,d,n){const l=oe;return g(),v("div",ke,[s.loading?(g(),k(O,{key:0,class:"text-center"},{default:m(()=>[p(ce,{size:"48",indeterminate:"",color:"primary"})]),_:1})):C("",!0),s.loading?C("",!0):(g(),k(O,{key:1},{default:m(()=>[p(he,{"sort-by":e.datatable.sortBy,"onUpdate:sortBy":t[3]||(t[3]=a=>e.datatable.sortBy=a),"items-per-page":0,height:e.$vuetify.display.height-390<320?320:e.$vuetify.display.height-390,headers:n.headers,items:n.filteredData,loading:s.loading,"loading-text":e.$t("Loading... Please wait"),"items-per-page-text":e.$t("Records per page"),"item-value":"_id","hide-default-footer":""},re({top:m(()=>[z(p(ge,{flat:"",color:"white"},{default:m(()=>[p(ye,{style:{"min-width":"150px"}},{default:m(()=>[A(h(e.$t("Summary")),1)]),_:1}),p(be,{class:"mx-4",inset:"",vertical:""}),p(Se,{modelValue:e.search,"onUpdate:modelValue":[t[0]||(t[0]=a=>e.search=a),n.setSearch],class:"mr-4 w-100",variant:"outlined",density:"compact",label:e.$t("Search"),"hide-details":"","prepend-icon":"mdi-magnify"},null,8,["modelValue","onUpdate:modelValue","label"])]),_:1},512),[[x,!e.$vuetify.display.xs]])]),headers:m(({columns:a,toggleSort:u})=>[N("tr",null,[(g(!0),v(ne,null,Y(a,c=>(g(),k(l,{key:c.key,onSetSort:t[1]||(t[1]=f=>e.datatable.sortBy=[f]),onSetFilter:t[2]||(t[2]=f=>n.setFilter(f)),column:c,"parent-items":n.filteredData,datatable:e.datatable},null,8,["column","parent-items","datatable"]))),128))])]),"item._id":m(({item:a})=>[p(fe,null,{default:m(()=>[p($e,{text:e.$t("Export to Excel")},{activator:m(({props:u})=>[a.isDonnation?C("",!0):(g(),k(L,de({key:0},u,{onClick:c=>n.createXLSX(a),size:"small",rounded:"2",variant:"text",color:"green-darken-2",icon:"mdi-file-excel-box"}),null,16,["onClick"]))]),_:2},1032,["text"])]),_:2},1024)]),"item.publicId":m(({item:a})=>[N("strong",Ve,h(a.publicId),1)]),"item.address.pCode1":m(({item:a})=>{var u;return[(u=a.address)!=null&&u.pCode4?(g(),v("span",Te,h(e.$t(a.address.pCode4.substring(0,4))),1)):C("",!0)]}),"item.address.pCode2":m(({item:a})=>{var u;return[(u=a.address)!=null&&u.pCode4?(g(),v("span",Ee,h(e.$t(a.address.pCode4.substring(0,6))),1)):C("",!0)]}),"item.address.pCode3":m(({item:a})=>{var u;return[(u=a.address)!=null&&u.pCode4?(g(),v("span",He,h(e.$t(a.address.pCode4.substring(0,9))),1)):C("",!0)]}),"item.address.pCode4":m(({item:a})=>{var u;return[(u=a.address)!=null&&u.pCode4?(g(),v("span",Me,h(e.$t(a.address.pCode4)),1)):C("",!0)]}),"item.date":m(({item:a})=>[A(h(new Date(a.date).toLocaleDateString("uk")),1)]),"no-data":m(()=>[N("div",null,h(e.$t("No data found")),1)]),_:2},[Y(e.$slots,(a,u)=>({name:u,fn:m(c=>[le(e.$slots,u,ue(me(c||{})))])}))]),1032,["sort-by","height","headers","items","loading","loading-text","items-per-page-text"])]),_:3})),s.loading?C("",!0):(g(),k(O,{key:2,class:"text-right"},{default:m(()=>[z(p(L,{onClick:n.exportRaw,class:"mr-2","prepend-icon":"mdi-download",color:"secondary"},{default:m(()=>[A(h(e.$t("Export raw")),1)]),_:1},8,["onClick"]),[[x,n.idAdmin]]),p(L,{onClick:n.exportData,color:"primary"},{default:m(()=>[A(h(e.$t("Export")),1)]),_:1},8,["onClick"])]),_:1}))])}const Pe=J(Ie,[["render",Le]]),Re=["In-kind","Cash","Voucher"],je={name:"CustomDistributionModality",props:{modelValue:{type:String},disabled:{type:Boolean}},computed:{model:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}},items(){return Re}}},Be={class:"distribution-modality"};function ze(e,t,s,i,d,n){return g(),v("div",Be,[p(X,{modelValue:n.model,"onUpdate:modelValue":t[0]||(t[0]=l=>n.model=l),label:e.$t("Assistance modality"),items:n.items,"item-title":l=>l?e.$t(l):"","item-value":l=>l,"no-data-text":e.$t("No data available"),variant:"underlined","hide-details":"auto",clearable:""},null,8,["modelValue","label","items","item-title","item-value","no-data-text"])])}const xe=J(je,[["render",ze]]);var Ue={IS_TEST:!0,FRONT_HOST:"https://raisplus-test.unhcr.in.ua",STATIC_ASSETS_PATH:"http://localhost:3000/static/",MS_APP_CLIENT_ID:"4f92930c-13d8-4c36-95d6-2f2d31727e6e",MS_APP_AUTHORITY:"https://login.microsoftonline.com/e5c37981-6664-4134-8a0c-6543d2af80be",BYPASS_MSAL:!0,LOCALE:"uk-ua",LANGUAGE:"uk",BACKEND_HOST:"http://localhost:3000/api/v1",APP_NAME:"rais-plus",APP_SHORTNAME:"RAIS+",APP_FULLNAME:"RAIS+ Ukraine Assistance Monitoring System",APP_DEFAULT_THEME:"gsc",APP_KEY:"UicablEChAKeyNOmerYONYmIkIMELACIstioNIUMItIcARterm"};const w={name:"reports",beforeMount(){var t,s,i,d,n;const e=localStorage.getItem("unhcr-rais-plus-recent-report");e||(this.filters["organization.id"]=(i=(s=(t=this.appStore)==null?void 0:t.user)==null?void 0:s.organization)==null?void 0:i.id,this.filters.date.$gte=new Date().toLocaleDateString("sv-SE").replace(/-\d+$/,"-01"),this.filters.date.$lte=new Date().toLocaleDateString("sv-SE")),this.organizations=[(n=(d=this.appStore)==null?void 0:d.user)==null?void 0:n.organization].filter(Boolean),e&&Object.assign(this.filters,JSON.parse(e)),this.getFiltersData(),this.appStore.loading=!1},computed:{isAdmin(){var e,t,s;return(s=(t=(e=this.appStore)==null?void 0:e.user)==null?void 0:t.role)==null?void 0:s.includes("Admin")},summaryHeaders(){return[]},indicatorsHeaders(){return[]},requiredFiltersAreSet(){return this.isAdmin?!0:[this.filters["organization.id"],this.filters.bundleName,this.filters.distributionModality].filter(Boolean).length===3}},data:()=>({organizations:[],filters:{"organization.id":void 0,bundleName:"SN101-2024",aor:[],distributionModality:"In-kind",populationType:[],date:{$lte:void 0,$gte:void 0},pCode1:void 0,pCode2:void 0,pCode3:void 0,pCode4:void 0},includeDonations:!1,summary:[],summaryLoading:!0,indicators:[],indicatorsLoading:!0}),methods:{async getFiltersData(){const{organizations:e}=this.$storage,t=await e.slice(0,500).filter({functionalType:["UN Agency","Operational partner","Implementing partner"]}).include(["id","name","translation.uk.name"]).sort([{name:"asc"}]).find();this.organizations=t.items},async getSummary(){if(this.summaryLoading=!0,!this.requiredFiltersAreSet)return this.summaryLoading=!1;let{assistances:e}=this.$storage;e=e.useIndex("bundleName");const t=Object.fromEntries(Object.entries(this.filters).filter(([,i])=>i));e.filter(t);let s=await e.aggregate({groupBy:["date","address.pCode4","collectiveCenter.name","organization.name","publicId"],aggs:{"familyStats.households":{variable:"address.pCode1",operation:"count"},"familyStats.all":{variable:"familyStats.all",operation:"sum"},"familyStats.girls":{variable:"familyStats.girls",operation:"sum"},"familyStats.boys":{variable:"familyStats.boys",operation:"sum"},"familyStats.men":{variable:"familyStats.men",operation:"sum"},"familyStats.women":{variable:"familyStats.women",operation:"sum"},"familyStats.seniorMen":{variable:"familyStats.seniorMen",operation:"sum"},"familyStats.seniorWomen":{variable:"familyStats.seniorWomen",operation:"sum"},"familyStats.disabled":{variable:"familyStats.disabled",operation:"sum"},"familyStats.vulnerable":{variable:"familyStats.vulnerable",operation:"sum"},items:{variable:"items",operation:"nested",nested:{groupBy:["key"],aggs:{value:{variable:"value",operation:"sum"}}}},strings:{variable:"strings",operation:"nested",nested:{groupBy:["key"],aggs:{value:{variable:"value",operation:"count"}}}},value:{variable:"value",operation:"sum"}}});if(s=s.map(i=>{var d,n,l,a,u,c;return i=B.object(i),i.items&&(i.items=M(i.items)),i.strings&&(i.strings=M(i.strings)),i.address.pCode1=(n=(d=i.address)==null?void 0:d.pCode4)==null?void 0:n.substring(0,4),i.address.pCode2=(a=(l=i.address)==null?void 0:l.pCode4)==null?void 0:a.substring(0,6),i.address.pCode3=(c=(u=i.address)==null?void 0:u.pCode4)==null?void 0:c.substring(0,9),i}),this.includeDonations){const i=Object.fromEntries([["bundleName",this.filters.bundleName],["distributionModality",this.filters.distributionModality],["organization.id",this.filters["organization.id"]]].filter(([,l])=>l)),{donations:d}=this.$storage,n=await d.useIndex("bundleName").filter({...i,date:{$lte:this.endDate,$gte:this.startDate}}).include(["publicId","familyStats","items","households","date","address","collectiveCenter"]).find();s.push(...n.items.map(l=>(l.isDonnation=!0,l.items=M(l.items),l.familyStats.households=l.households,l)))}this.summary=s,this.summaryLoading=!1},async getIndicators(){this.indicatorsLoading=!0;let t=(await this.$api.data.getIndicators({startDate:this.startDate,endDate:this.endDate})).data;t=t.map(c=>c);const s=`${Ue.FRONT_HOST}/export/export.xlsx`,i="Indicators report.xlsx",d=[["orangization","Organisation Name"],["region","Location Region"],["raion","Location Raion"],["hromada","Location Hromada"],["settlement","Location Settlement"],["collectiveCenter","Location Site"],["month","Reporting Month"],["output","Indicators Output"],["indicator","Indicators Indicator"],["nonKit","Kit-NonKit Kit-NonKit"],["populationType","PoC Category PoC Category"],["modality","Modality Modality"],["households","Households"],["girls","GIRLS (<18 years)"],["boys","BOYS (<18 years)"],["women","WOMEN (18-59 years)"],["men","MEN (18-59 years)"],["seniorWomen","ELDERLY WOMEN (60+)"],["seniorMen","ELDERLY MEN (60+)"],["disabled","PEOPLE WITH DISABILITIES"]];this.filters.distributionModality!=="In-kind"&&d.push(["value","Value"]);const n=d.map(c=>c[1]),a=d.map(c=>c[0]).map(c=>t.map(f=>j(c,f)));(async()=>await U(s,{headers:n,columns:a},i))(),this.indicatorsLoading=!1},getData(){this.getSummary()}},watch:{filters:{deep:!0,handler(e){localStorage.setItem("unhcr-rais-plus-recent-report",JSON.stringify(e)),this.getData()}}}},Je={class:"reports pa-2"},Fe={class:"text-h5 mb-2 offset-md1 black--text"},Ke={class:"text-h5 mb-2 offset-md1 black--text"};function Ye(e,t,s,i,d,n){const l=Ce,a=xe,u=Oe,c=Pe;return g(),v("div",Je,[p(P,{class:"mb-0 mt-0"},{default:m(()=>[p(O,{cols:"12",md:"12",class:"mb-0 mt-0 pb-0 pt-0"},{default:m(()=>[p(ve,null,{default:m(()=>[p(Ae,null,{default:m(()=>[p(P,null,{default:m(()=>[p(O,{cols:"12",md:"3",class:"pl-md-4"},{default:m(()=>[N("div",Fe,h(e.$t("Filters")),1),N("div",null,h(e.$t("Define the filters for your report")),1),N("div",null,[p(X,{modelValue:e.filters["organization.id"],"onUpdate:modelValue":t[0]||(t[0]=f=>e.filters["organization.id"]=f),label:e.$t("Organization"),items:e.organizations,"item-title":f=>{var D,_;return e.$i18n.locale==="en"?f.name:((_=(D=f.translation)==null?void 0:D[e.$i18n.locale])==null?void 0:_.name)||""},clearable:n.isAdmin,"item-value":"id",class:"mt-4",variant:"underlined"},null,8,["modelValue","label","items","item-title","clearable"]),p(l,{modelValue:e.filters.bundleName,"onUpdate:modelValue":t[1]||(t[1]=f=>e.filters.bundleName=f)},null,8,["modelValue"]),p(a,{class:"mt-4",modelValue:e.filters.distributionModality,"onUpdate:modelValue":t[2]||(t[2]=f=>e.filters.distributionModality=f)},null,8,["modelValue"]),p(u,{modelValue:e.filters.date.$gte,"onUpdate:modelValue":[t[3]||(t[3]=f=>e.filters.date.$gte=f),n.getData],label:e.$t("Start of report period"),class:"mt-4"},null,8,["modelValue","onUpdate:modelValue","label"]),p(u,{modelValue:e.filters.date.$lte,"onUpdate:modelValue":[t[4]||(t[4]=f=>e.filters.date.$lte=f),n.getData],label:e.$t("End of report period")},null,8,["modelValue","onUpdate:modelValue","label"]),z(p(Ne,{modelValue:e.includeDonations,"onUpdate:modelValue":[t[5]||(t[5]=f=>e.includeDonations=f),n.getData],label:e.$t("Include donations")},null,8,["modelValue","onUpdate:modelValue","label"]),[[x,e.filters.distributionModality==="In-kind"]])])]),_:1}),p(O,{cols:"12",md:"9",class:"pr-md-4"},{default:m(()=>[p(P,null,{default:m(()=>[p(O,{cols:"12"},{default:m(()=>[p(R,{color:"primary",class:"mr-2"},{default:m(()=>[A(h(e.$t("Summaries")),1)]),_:1}),p(R,{link:"",to:"/indicators",class:"mr-2"},{default:m(()=>[A(h(e.$t("Indicators")),1)]),_:1}),p(R,{link:"",to:"/custom-indicators"},{default:m(()=>[A(h(e.$t("Custom indicators")),1)]),_:1})]),_:1}),p(O,{cols:"12"},{default:m(()=>[N("div",Ke,h(e.$t("Distribution summary")),1)]),_:1}),p(O,null,{default:m(()=>[p(c,{data:e.summary,filters:e.filters,startDate:e.filters.date.$gte,endDate:e.filters.date.$lte,loading:e.summaryLoading},null,8,["data","filters","startDate","endDate","loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})])}typeof W=="function"&&W(w);const _t=J(w,[["render",Ye]]);export{_t as default};
