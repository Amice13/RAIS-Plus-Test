import{_ as E}from"./ImportUploadBox-BXX-wJvU.js";import{_ as R,a as L,b as B}from"./CustomMultipleBundle-D5JEGacT.js";import{_ as z,ac as F,a5 as J,Y,a6 as G,F as C,a as o,w as r,o as m,z as d,A as l,c as k,B as h,x as A,y as x,C as p,a4 as K,a8 as j,G as O,H as $}from"./index-BYWsBYtF.js";import{d as q}from"./index-D0pvfY44.js";import{b as T}from"./route-block-B_A1xBdJ.js";import{a as D,V as v}from"./VRow-D5QUgmxK.js";import{V as w}from"./VDialog-DkfmLzLV.js";import{V as P,a as M,b as X}from"./VCard-C8It3tDs.js";import{a as Q,V as S}from"./VBtn-DEU8AXzn.js";import{V as W}from"./VDataTable-DS7yi-Dm.js";import{V as Z,a as ee}from"./VToolbar-Jw3O4Zrq.js";import{d as te}from"./VList-wnBQ6eUC.js";import{V as se}from"./VTextField-CLSPMm7c.js";import{V as H}from"./VSpacer-D4hnwTqC.js";import{V as ae}from"./VChip-BnTEbD1P.js";import{V as le}from"./index-CqdMy8lr.js";import"./comlink-DRT95HA4.js";import"./filter-5KaMYqe0.js";import"./VInput-CwTs2RKk.js";import"./index-bmXFo_Al.js";import"./forwardRefs-D3j0TLhE.js";import"./dialog-transition-CdzLxCw9.js";import"./VMenu-BAWQ3Wct.js";import"./VOverlay-uyg0Ioz0.js";import"./VCheckboxBtn-B1hdxoeT.js";import"./VAvatar-Bm8XvpvO.js";import"./VImg-wiXIkP7s.js";/* empty css              */import"./group-BcbT0sDe.js";import"./VPagination-BBLVO-bG.js";var re={IS_TEST:!0,FRONT_HOST:"https://raisplus-test.unhcr.in.ua",STATIC_ASSETS_PATH:"http://localhost:3000/static/",MS_APP_CLIENT_ID:"4f92930c-13d8-4c36-95d6-2f2d31727e6e",MS_APP_AUTHORITY:"https://login.microsoftonline.com/e5c37981-6664-4134-8a0c-6543d2af80be",BYPASS_MSAL:!0,LOCALE:"uk-ua",LANGUAGE:"uk",BACKEND_HOST:"http://localhost:3000/api/v1",APP_NAME:"rais-plus",APP_SHORTNAME:"RAIS+",APP_FULLNAME:"RAIS+ Ukraine Assistance Monitoring System",APP_DEFAULT_THEME:"gsc",APP_KEY:"UicablEChAKeyNOmerYONYmIkIMELACIstioNIUMItIcARterm"};const ie={Duplicated:"red-darken-2","This tax ID is invalid":"yellow-darken-2","Planned support":"pink-accent-4",Unique:"green-darken-2","Duplicated family member":"orange-darken-2","Planned support for a family member":"pink-darken-4"},U={inject:["$error","$loading"],name:"Deduplication",mounted(){this.appStore.loading=!1},computed:{translatedHeaders(){return this.$i18n.locale==="en"?this.headers:JSON.parse(JSON.stringify(this.headers)).map(i=>(i.title=this.$t(i.title),i))},dialog(){return this.currentItem.length>0}},data(){return{search:void 0,loading:!1,filters:{items:{$nested:{key:[]}}},rows:[],results:[],currentItem:[],headers:[{title:"Tax ID",align:"start",value:"taxId",sortable:!0},{title:"Passport",align:"start",value:"passport",sortable:!0},{title:"Result",align:"start",value:"result",sortable:!0},{title:"Date",align:"start",value:"date",sortable:!0},{title:"Bundle name",align:"start",value:"bundleName",sortable:!0},{title:"Organization",align:"start",value:"organization.name"},{title:"Oblast",align:"start",value:"address.pCode1"},{title:"Raion",align:"start",value:"address.pCode2"},{title:"Hromada",align:"start",value:"address.pCode3"},{title:"Locality",align:"start",value:"address.pCode4"}]}},methods:{async checkAll(){let t=JSON.parse(JSON.stringify(this.rows));if(Array.isArray(t)||(t=[t]),t.length===1&&!Array.isArray(t[0])&&(t=[t]),t=t.map(e=>e[0]).filter(Boolean),!t.length)return!1;if(this.loading=!0,t.length>1e4)return this.loading=!1,await this.$error({title:"Can't process more than 10 000 records at once"});let i=t.filter(Boolean).map(e=>{if(e=String(e).replace(/[^А-Я\d]/gi,""),/^\d{9}$/.test(e))return{passport:e};if(/^[А-ЯЄІЇ]{2} *\d{6}$/.test(e.toUpperCase()))return{passport:e.toUpperCase().replace(/^([А-Я]{2})(\d{6})/g,"$1 $2")};const u=F(e);return u?u.result==="warning"?{taxId:e,result:"This tax ID is invalid"}:{taxId:e}:{taxId:e,result:"This tax ID is invalid"}});const V=i.filter(e=>!e.result).map(e=>e.taxId||e.passport).filter(Boolean),{assistances:y}=this.$storage,a=JSON.parse(JSON.stringify(this.filters)),c=[a];if(!a.distributionModality||a.distributionModality.includes("Cash")||a.distributionModality.includes("Voucher")){const e={distributionModality:a.distributionModality,value:{$gt:0}};e.distributionModality||delete e.distributionModality,c.push(e)}let g=await y.useIndex("peopleIds").slice(0,1e4).filter({peopleIds:V}).should(c).include(["headOfHousehold.givenName","headOfHousehold.taxId","headOfHousehold.passport","familyMembers.taxId","familyMembers.passport","date","bundleName","organization.name","admin1","admin2","admin3","admin4","address.pCode1","address.pCode2","address.pCode3","address.pCode4"]).find();g.count||(this.results=i,this.loading=!1),g.items=g.items.map(e=>J.object(e)),i=i.map(e=>{var s,n;if(e.result)return e;let u=[];if(e.passport&&(u=g.items.filter(f=>{var b;return((b=f.headOfHousehold)==null?void 0:b.passport)===e.passport})),e.taxId&&(u=g.items.filter(f=>{var b,_;return(b=f.headOfHousehold)!=null&&b.taxId&&((_=f.headOfHousehold)==null?void 0:_.taxId)===e.taxId?!0:f.taxIds&&f.taxIds.includes(e.taxId)})),!u.length)return{...e,result:"Unique"};let I={...u[0],...e,items:u};return e.taxId&&((s=u[0].headOfHousehold)==null?void 0:s.taxId)===e.taxId||e.passport&&((n=u[0].headOfHousehold)==null?void 0:n.passport)===e.passport?(I.result=new Date(u[0].date)<new Date?"Duplicated":"Planned support",I):(I.result=new Date(u[0].date)<new Date?"Duplicated family member":"Planned support for a family member",I)}),this.results=i,this.loading=!1},formatDate(t){return t?Y(t).toLocaleDateString("uk"):""},getColor(t){return ie[t]},getFileName(){var y,a,c,g;const t=((a=(y=this.appStore)==null?void 0:y.user)==null?void 0:a.name)||"User",i=((g=(c=this.appStore)==null?void 0:c.user)==null?void 0:g.email)||"no@email";return`${new Date().toISOString().substring(0,10)} - Deduplication data for ${t} (${i}).xlsx`},exportData(){let t=JSON.parse(JSON.stringify(this.results));const i=["Tax ID","Passport","Result","Date","Bundle name","Organization","Oblast","Raion","Hromada","Locality","pCode1","pCode2","pCode3","pCode4"],V=["taxId","passport","result","date","bundleName","organization.name","admin1","admin2","admin3","admin4","address.pCode1","address.pCode2","address.pCode3","address.pCode4"],y=`${re.FRONT_HOST}/export/export.xlsx`,a=this.getFileName();t=t.map(e=>{var u;return e.bundleName=this.$t(e.bundleName),(u=e.address)!=null&&u.pCode4&&(e.address.pCode1=e.address.pCode4.substring(0,4),e.address.pCode2=e.address.pCode4.substring(0,6),e.address.pCode3=e.address.pCode4.substring(0,9),e.admin1=e.address.pCode4?this.$t(e.address.pCode4.substring(0,4),"en"):"",e.admin2=e.address.pCode4?this.$t(e.address.pCode4.substring(0,6),"en"):"",e.admin3=e.address.pCode4?this.$t(e.address.pCode4.substring(0,9),"en"):"",e.admin4=e.address.pCode4?this.$t(e.address.pCode4,"en"):""),e});const c=V.map(e=>t.map(u=>G(e,u)));(async()=>await q(y,{headers:i,columns:c},a))()}}},oe={class:"guide pa-2"},de={class:"text-h4 font-weight-bold"},ne={class:"text-h5 mb-2 offset-md1 black--text"},ue={class:"mt-4"},me={style:{"white-space":"nowrap"}},pe={sclass:"text-no-wrap"},ce={class:"text-no-wrap"},fe={class:"text-no-wrap"},he={class:"d-flex w-100"},ge={class:"bg-blue-grey-lighten-5 pa-4 flex-grow-1"},be={class:"text-h6 mt-4"},_e={class:"mb-6 mt-2"},Ce={class:"mt-2 mb-2"},ye={key:0,class:"mt-2 mb-2"},ve={key:1,class:"mt-2 mb-2"},Ie={key:2,class:"mt-2 mb-2"},ke={key:3,class:"mt-2 mb-2"},Ve={class:"mt-2 mb-2"},De={key:4,class:"mt-2 mb-2"},Ne={class:"ml-6"},Se={key:5,class:"mt-2 mb-2"};function Ae(t,i,V,y,a,c){const g=R,e=L,u=B,I=E;return m(),C("div",oe,[o(D,{class:"mb-0 mt-0"},{default:r(()=>[o(v,{cols:"12",md:"12",class:"mb-0 mt-0 pb-4 pt-0 pl-md-8 pr-md-8"},{default:r(()=>[d("div",de,l(t.$t("Deduplication")),1)]),_:1})]),_:1}),o(D,{class:"mb-0 mt-0"},{default:r(()=>[o(v,{cols:"12",md:"12",class:"mb-0 mt-0 pb-0 pt-0 pl-md-8 pr-md-8"},{default:r(()=>[o(P,{class:"pt-sm-4 pb-sm-4 pt-md-16 pb-md-16"},{default:r(()=>[o(M,null,{default:r(()=>[o(D,null,{default:r(()=>[o(v,{cols:"12",md:"3",class:"pl-md-16"},{default:r(()=>{var s,n,f,b;return[d("div",ne,l(t.$t("Deduplication")),1),d("div",null,l(t.$t("Please specify the necessary filter and provide the list of tax IDs to obtain information regarding the support provided")),1),d("div",ue,[o(g,{modelValue:a.filters.bundleName,"onUpdate:modelValue":i[0]||(i[0]=_=>a.filters.bundleName=_)},null,8,["modelValue"]),o(e,{modelValue:a.filters.distributionModality,"onUpdate:modelValue":i[1]||(i[1]=_=>a.filters.distributionModality=_),class:"mt-4"},null,8,["modelValue"]),((n=(s=a.filters)==null?void 0:s.bundleName)==null?void 0:n.length)===1&&((b=(f=a.filters)==null?void 0:f.distributionModality)==null?void 0:b.length)===1&&a.filters.distributionModality[0]==="In-kind"?(m(),k(u,{key:0,modelValue:a.filters.items.$nested.key,"onUpdate:modelValue":i[2]||(i[2]=_=>a.filters.items.$nested.key=_),bundle:a.filters.bundleName[0],class:"mt-4"},null,8,["modelValue","bundle"])):h("",!0)])]}),_:1}),o(v,{cols:"12",md:"9",class:"pr-md-16"},{default:r(()=>[o(D,null,{default:r(()=>[!a.loading&&!a.results.length?(m(),k(v,{key:0,cols:"12"},{default:r(()=>[o(I,{modelValue:a.rows,"onUpdate:modelValue":[i[3]||(i[3]=s=>a.rows=s),c.checkAll],"bundle-name":"none",checkAll:""},null,8,["modelValue","onUpdate:modelValue"])]),_:1})):h("",!0),a.loading?(m(),k(v,{key:1,cols:"12",class:"text-center"},{default:r(()=>[o(Q,{color:"primary",indeterminate:"",size:"x-large"})]),_:1})):h("",!0),!a.loading&&a.results.length?(m(),k(v,{key:2,cols:"12",class:"pt-0"},{default:r(()=>[o(W,{items:a.results,headers:c.translatedHeaders,search:a.search,"no-data-text":t.$t("No data available"),"items-per-page-text":t.$t("Items per page")},{top:r(()=>[A(o(Z,{flat:"",color:"white"},{default:r(()=>[o(ee,{style:{"min-width":"150px"}},{default:r(()=>[p(l(t.$t("Results")),1)]),_:1}),o(te,{class:"mx-4",inset:"",vertical:""}),o(se,{modelValue:a.search,"onUpdate:modelValue":i[4]||(i[4]=s=>a.search=s),class:"mr-4 w-100",variant:"outlined",density:"compact",label:t.$t("Search"),"hide-details":"","prepend-icon":"mdi-magnify"},null,8,["modelValue","label"]),o(H),K(t.$slots,"action-btn",{},()=>[o(S,{onClick:i[5]||(i[5]=s=>a.results=[]),color:"error",variant:"text",class:"mr-2"},{default:r(()=>[p(l(t.$t("Reset")),1)]),_:1}),o(S,{onClick:c.exportData,color:"primary",variant:"tonal"},{default:r(()=>[p(l(t.$t("Export")),1)]),_:1},8,["onClick"])])]),_:3},512),[[x,!t.$vuetify.display.xs]])]),"item.address.pCode1":r(({item:s})=>{var n;return[p(l(((n=s.address)==null?void 0:n.pCode4)&&t.$t(s.address.pCode4.substring(0,4))),1)]}),"item.address.pCode2":r(({item:s})=>{var n;return[p(l(((n=s.address)==null?void 0:n.pCode4)&&t.$t(s.address.pCode4.substring(0,6))),1)]}),"item.address.pCode3":r(({item:s})=>{var n;return[p(l(((n=s.address)==null?void 0:n.pCode4)&&t.$t(s.address.pCode4.substring(0,9))),1)]}),"item.address.pCode4":r(({item:s})=>{var n;return[p(l(((n=s.address)==null?void 0:n.pCode4)&&t.$t(s.address.pCode4)),1)]}),"item.result":r(({item:s})=>[d("span",me,[o(ae,{onClick:n=>a.currentItem=s.items,class:j({"cursor-pointer":["Duplicated family member","Duplicated"].includes(s.result)}),label:"",color:c.getColor(s.result),variant:"elevated",size:"small"},{default:r(()=>[p(l(t.$t(s.result))+" ",1),["Duplicated family member","Duplicated"].includes(s.result)?(m(),k(le,{key:0,class:"ml-2"},{default:r(()=>i[7]||(i[7]=[p(" mdi-information ")])),_:1})):h("",!0)]),_:2},1032,["onClick","class","color"])])]),"item.bundleName":r(({item:s})=>[d("span",pe,l(t.$t(s.bundleName)),1)]),"item.organization":r(({item:s})=>{var n;return[d("span",ce,l((n=s.organization)==null?void 0:n.name),1)]}),"item.date":r(({item:s})=>[d("span",fe,l(c.formatDate(s.date)),1)]),_:2},1032,["items","headers","search","no-data-text","items-per-page-text"])]),_:3})):h("",!0)]),_:3})]),_:3})]),_:3})]),_:3})]),_:3})]),_:3})]),_:3}),o(w,{"model-value":c.dialog},{default:r(()=>[o(P,{title:t.$t("Duplications"),"max-width":"600",class:"margin-auto custom-thumb"},{default:r(()=>[a.currentItem.length?(m(),k(M,{key:0},{default:r(()=>[d("div",he,[d("div",ge,[d("div",be,l(t.$t("Deduplication results")),1),d("div",_e,[d("div",null,[d("strong",null,l(t.$t("This person has already received the support from humanitarian organizations")),1)])]),(m(!0),C(O,null,$(a.currentItem,s=>{var n,f,b,_;return m(),C("div",{key:s.publicId,class:"mb-7 pl-2",style:{"border-left":"2px solid #039BE5"}},[d("div",Ce,[d("strong",null,l(t.$t("Date"))+":",1),p(" "+l(new Date(s.date).toLocaleDateString("uk")),1)]),s.bundleName?(m(),C("div",ye,[d("strong",null,l(t.$t("Assistance type"))+":",1),p(" "+l(t.$t(s.bundleName)),1)])):h("",!0),(n=s.address)!=null&&n.pCode1?(m(),C("div",ve,[d("strong",null,l(t.$t("Oblast"))+":",1),p(" "+l(t.$t(s.address.pCode1)),1)])):h("",!0),(f=s.address)!=null&&f.pCode2?(m(),C("div",Ie,[d("strong",null,l(t.$t("Raion"))+":",1),p(" "+l(t.$t(s.address.pCode2)),1)])):h("",!0),(b=s.address)!=null&&b.pCode4?(m(),C("div",ke,[d("strong",null,l(t.$t("Locality"))+":",1),p(" "+l(t.$t(s.address.pCode4)),1)])):h("",!0),d("div",Ve,[d("strong",null,l(t.$t("Organization"))+":",1),p(" "+l((_=s.organization)==null?void 0:_.name),1)]),s.items&&s.items.length?(m(),C("div",De,[d("div",null,[d("strong",null,l(t.$t("Items"))+":",1)]),d("ul",Ne,[(m(!0),C(O,null,$(s.items,N=>A((m(),C("li",null,l(t.$t(N.key))+": "+l(N.value),513)),[[x,N.value]])),256))])])):h("",!0),s.value?(m(),C("div",Se,[d("strong",null,l(t.$t("Value"))+":",1),p(" "+l(s.value?s.value.toLocaleString("uk-UA",{style:"currency",currency:s.currency||"USD"}):""),1)])):h("",!0)])}),128))])])]),_:1})):h("",!0),o(X,null,{default:r(()=>[o(H),o(S,{text:t.$t("Close"),color:"primary",onClick:i[6]||(i[6]=s=>a.currentItem=[])},null,8,["text"])]),_:1})]),_:1},8,["title"])]),_:1},8,["model-value"])])}typeof T=="function"&&T(U);const rt=z(U,[["render",Ae]]);export{rt as default};
